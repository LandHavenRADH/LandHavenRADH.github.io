<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Database | Restaurant GroundWorks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-cell {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        .editable-cell:hover {
            background-color: #f1f5f9; /* slate-100 */
            cursor: pointer;
        }
        .table-cell[contenteditable="true"] {
            background-color: #fef9c3; /* yellow-100 */
            outline: 2px solid #f59e0b; /* amber-500 */
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        #map, #competitor-map {
            height: 500px;
            width: 100%;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }
        #modal-image {
            max-width: 90vw;
            max-height: 90vh;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Main Content (Initially Hidden) -->
    <div id="main-content" class="hidden">
        <!-- Header -->
        <header id="header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="font-extrabold text-2xl text-slate-900">
                        Restaurant GroundWorks
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="client-database.html" class="bg-slate-200 text-slate-800 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition-colors">
                            Client Database
                        </a>
                        <a href="broker-database.html" class="bg-slate-200 text-slate-800 font-bold py-2 px-5 rounded-lg hover:bg-slate-300 transition-colors">
                            Broker Database
                        </a>
                        <button id="logout-button" class="bg-amber-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-amber-600 transition-colors">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-12">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900">Property Database</h1>
                <p class="text-lg text-slate-600 mt-4 max-w-3xl mx-auto">A shared database of properties for sale, updated live from our central database.</p>
            </div>

            <!-- Add Property Form -->
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 mb-12">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Add a New Property</h2>
                <form id="add-property-form" class="grid md:grid-cols-4 gap-6">
                    <div class="md:col-span-2">
                        <label for="address" class="block text-slate-700 font-medium mb-2">Address</label>
                        <input type="text" id="address" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 123 Main St" required>
                    </div>
                    <div>
                        <label for="city" class="block text-slate-700 font-medium mb-2">City</label>
                        <input type="text" id="city" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Indianapolis" required>
                    </div>
                     <div>
                        <label for="state" class="block text-slate-700 font-medium mb-2">State</label>
                        <select id="state" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-white">
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN" selected>Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                        </select>
                    </div>
                    <div>
                        <label for="price" class="block text-slate-700 font-medium mb-2">Asking Price ($)</label>
                        <input type="number" id="price" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 750000" required>
                    </div>
                    <div>
                        <label for="acres" class="block text-slate-700 font-medium mb-2">Land Area (Acres)</label>
                        <input type="number" step="0.01" id="acres" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 1.75">
                    </div>
                    <div>
                        <label for="dom" class="block text-slate-700 font-medium mb-2">Initial Days on Market</label>
                        <input type="number" id="dom" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 30">
                    </div>
                    <div>
                        <label for="trafficRoad1" class="block text-slate-700 font-medium mb-2">Primary Road Name</label>
                        <input type="text" id="trafficRoad1" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Main St">
                    </div>
                    <div>
                        <label for="aadt" class="block text-slate-700 font-medium mb-2">Primary Traffic (AADT)</label>
                        <input type="number" id="aadt" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 15000">
                    </div>
                     <div>
                        <label for="trafficRoad2" class="block text-slate-700 font-medium mb-2">Secondary Road Name</label>
                        <input type="text" id="trafficRoad2" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., I-469">
                    </div>
                    <div>
                        <label for="aadt2" class="block text-slate-700 font-medium mb-2">Secondary Traffic (AADT)</label>
                        <input type="number" id="aadt2" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 32000">
                    </div>
                    <div>
                        <label for="populationRadius" class="block text-slate-700 font-medium mb-2">Population Radius (mi)</label>
                        <input type="number" id="populationRadius" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 5">
                    </div>
                     <div>
                        <label for="population" class="block text-slate-700 font-medium mb-2">Population</label>
                        <input type="number" id="population" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 83312">
                    </div>
                    <div>
                        <label for="signalized-intersection" class="block text-slate-700 font-medium mb-2">Signalized Intersection</label>
                        <select id="signalized-intersection" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-white">
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label for="intendedRoi" class="block text-slate-700 font-medium mb-2">Intended ROI (%)</label>
                        <input type="number" step="0.01" id="intendedRoi" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 15.00">
                    </div>
                    <div>
                        <label for="capRate" class="block text-slate-700 font-medium mb-2">Capitalization Rate (%)</label>
                        <input type="number" step="0.01" id="capRate" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 5.20">
                    </div>
                    <div class="md:col-span-2">
                        <label for="file-upload" class="block text-slate-700 font-medium mb-2">Upload File</label>
                        <input type="file" id="file-upload" class="w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    </div>
                     <div class="md:col-span-2">
                        <label for="photo-upload" class="block text-slate-700 font-medium mb-2">Upload Photo</label>
                        <input type="file" id="photo-upload" accept="image/*" class="w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                    </div>
                    <div class="md:col-span-4">
                        <label for="notes" class="block text-slate-700 font-medium mb-2">Notes</label>
                        <textarea id="notes" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., High traffic corner, zoned for commercial use..."></textarea>
                    </div>
                    <div class="md:col-span-4 text-right">
                        <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors">
                            Add Property
                        </button>
                    </div>
                </form>
            </div>

            <!-- Search Form -->
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 mb-12">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Search & Filter</h2>
                <form id="search-form" class="grid md:grid-cols-4 gap-6">
                    <div>
                        <label for="search-address" class="block text-slate-700 font-medium mb-2">Address</label>
                        <input type="text" id="search-address" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="search-city" class="block text-slate-700 font-medium mb-2">City</label>
                        <input type="text" id="search-city" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="search-state" class="block text-slate-700 font-medium mb-2">State</label>
                        <input type="text" id="search-state" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="search-min-price" class="block text-slate-700 font-medium mb-2">Min Price</label>
                        <input type="number" id="search-min-price" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="search-max-price" class="block text-slate-700 font-medium mb-2">Max Price</label>
                        <input type="number" id="search-max-price" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="search-min-acres" class="block text-slate-700 font-medium mb-2">Min Acres</label>
                        <input type="number" id="search-min-acres" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="search-max-acres" class="block text-slate-700 font-medium mb-2">Max Acres</label>
                        <input type="number" id="search-max-acres" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div class="md:col-span-4 flex justify-end space-x-4">
                        <button type="button" id="clear-search-button" class="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600">Clear</button>
                        <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Search</button>
                    </div>
                </form>
            </div>

            <!-- Map Error Message -->
            <div id="map-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Map Error:</strong>
                <span class="block sm:inline">Could not place pins on the map. Please ensure your Google Maps API key is correct, has billing enabled, and that both the "Maps JavaScript API" and "Geocoding API" are enabled in your Google Cloud project.</span>
            </div>

            <!-- Google Map -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 mb-12">
                <div id="map" class="rounded-xl"></div>
            </div>
            
            <div class="flex space-x-4 mb-4">
                <button id="export-button" class="bg-green-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-green-600 transition-colors">
                    Export Selected to Excel
                </button>
                <button id="compare-button" class="bg-blue-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-600 transition-colors">
                    Compare Selected
                </button>
            </div>

            <!-- Property Database Table -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-x-auto mb-12">
                <table class="w-full text-left">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="table-cell"><input type="checkbox" id="select-all"></th>
                            <th class="table-cell font-semibold">Photo</th>
                            <th class="table-cell font-semibold sortable-header" data-key="address">Address</th>
                            <th class="table-cell font-semibold sortable-header" data-key="city">City</th>
                            <th class="table-cell font-semibold sortable-header" data-key="state">State</th>
                            <th class="table-cell font-semibold sortable-header" data-key="price">Asking Price</th>
                            <th class="table-cell font-semibold sortable-header" data-key="acres">Acres</th>
                            <th class="table-cell font-semibold sortable-header" data-key="sqft">Sq. Footage (Calc.)</th>
                            <th class="table-cell font-semibold sortable-header" data-key="pricePerSqFt">Price per SF</th>
                            <th class="table-cell font-semibold sortable-header" data-key="dom">Current DOM</th>
                            <th class="table-cell font-semibold sortable-header" data-key="aadt">Traffic Count</th>
                            <th class="table-cell font-semibold sortable-header" data-key="signalizedIntersection">Signalized Intersection</th>
                            <th class="table-cell font-semibold sortable-header" data-key="intendedRoi">Intended ROI</th>
                            <th class="table-cell font-semibold sortable-header" data-key="capRate">Cap Rate</th>
                            <th class="table-cell font-semibold sortable-header" data-key="minRent">Min. Rental Rate</th>
                            <th class="table-cell font-semibold">Notes</th>
                            <th class="table-cell font-semibold">Attachment</th>
                            <th class="table-cell font-semibold text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="property-table-body">
                        <!-- Property rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- AI Zoning Analyzer -->
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 mb-12">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">AI Zoning Analyzer</h2>
                <form id="zoning-form" class="grid md:grid-cols-3 gap-6">
                    <div>
                        <label for="zoning-municipality" class="block text-slate-700 font-medium mb-2">County/Municipality</label>
                        <input type="text" id="zoning-municipality" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="zoning-designation" class="block text-slate-700 font-medium mb-2">Zoning Designation</label>
                        <input type="text" id="zoning-designation" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" id="get-zoning-info-button" class="w-full bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600">Get Zoning Info</button>
                    </div>
                </form>
                <div id="zoning-results-container" class="hidden mt-6 prose max-w-none"></div>
            </div>

            <!-- AI Franchise Site Analyzer -->
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 mb-12">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">AI Franchise Site Analyzer</h2>
                <form id="franchise-form" class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label for="franchise-name" class="block text-slate-700 font-medium mb-2">Franchise Name</label>
                        <input type="text" id="franchise-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Burger King" required>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" id="get-franchise-info-button" class="w-full bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600">Get Site Requirements</button>
                    </div>
                </form>
                <div id="franchise-results-container" class="hidden mt-6 prose max-w-none"></div>
            </div>
            
            <!-- AI Deed Restriction Analyzer -->
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">AI Deed Restriction Analyzer</h2>
                <form id="deed-form" class="grid md:grid-cols-3 gap-6">
                    <div class="md:col-span-2">
                        <label for="deed-upload" class="block text-slate-700 font-medium mb-2">Upload Deed (Word Document)</label>
                        <input type="file" id="deed-upload" accept=".doc,.docx" class="w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required/>
                    </div>
                    <div class="flex items-end">
                        <button type="submit" id="analyze-deed-button" class="w-full bg-rose-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-rose-600">Analyze Document</button>
                    </div>
                </form>
                <div id="deed-results-container" class="hidden mt-6 prose max-w-none"></div>
                <div id="deed-print-container" class="hidden mt-6 text-right">
                    <button id="print-deed-analysis-button" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">Download PDF</button>
                </div>
            </div>
        </main>

        <footer class="bg-slate-900 text-slate-400 mt-16">
            <div class="container mx-auto px-6 py-8 text-center">
                <p class="font-bold text-white text-lg mb-2">Restaurant GroundWorks</p>
                <p>&copy; 2025 Restaurant GroundWorks. All Rights Reserved.</p>
            </div>
        </footer>
    </div>
    
    <!-- Image Modal -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="relative">
            <button id="close-modal" class="absolute -top-4 -right-4 text-white bg-red-500 rounded-full h-8 w-8 flex items-center justify-center">&times;</button>
            <img id="modal-image" src="" alt="Enlarged property photo" class="max-w-[90vw] max-h-[90vh]">
        </div>
    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg relative">
             <button id="close-details-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 id="modal-address" class="text-2xl font-bold text-slate-800 mb-4"></h2>
            <img id="modal-details-image" src="" alt="Property photo" class="w-full h-64 object-cover rounded-md mb-4">
            <div class="grid grid-cols-2 gap-4 text-slate-700">
                <p><strong>Asking Price:</strong> <span id="modal-price"></span></p>
                <p><strong>Acres:</strong> <span id="modal-acres"></span></p>
                <p><strong>Traffic Count (AADT):</strong> <span id="modal-aadt"></span></p>
                <p><strong>Notes:</strong> <span id="modal-notes"></span></p>
            </div>
        </div>
    </div>
    
    <!-- Proposal Modal -->
    <div id="proposal-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl relative">
            <button id="close-proposal-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Generate Lease Proposal</h2>
            <form id="proposal-form" class="grid grid-cols-2 gap-4">
                <input type="hidden" id="proposal-property-id">
                <div>
                    <label for="proposal-date" class="block text-slate-700 font-medium mb-2">Date</label>
                    <input type="date" id="proposal-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="proposal-tenant" class="block text-slate-700 font-medium mb-2">Tenant Name</label>
                    <input type="text" id="proposal-tenant" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div class="col-span-2">
                    <label for="proposal-tenant-address" class="block text-slate-700 font-medium mb-2">Tenant Address</label>
                    <textarea id="proposal-tenant-address" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required></textarea>
                </div>
                <div>
                    <label for="proposal-lease-term" class="block text-slate-700 font-medium mb-2">Lease Term (years)</label>
                    <input type="number" id="proposal-lease-term" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="proposal-annual-rent" class="block text-slate-700 font-medium mb-2">Annual Rent ($)</label>
                    <input type="number" id="proposal-annual-rent" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="proposal-expense-structure" class="block text-slate-700 font-medium mb-2">Expense Structure</label>
                    <input type="text" id="proposal-expense-structure" value="NNN" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="proposal-renewal-options" class="block text-slate-700 font-medium mb-2">Renewal Options</label>
                    <input type="text" id="proposal-renewal-options" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Two 5-year options">
                </div>
                <div class="col-span-2">
                    <label for="proposal-delivery-condition" class="block text-slate-700 font-medium mb-2">Delivery Condition</label>
                    <input type="text" id="proposal-delivery-condition" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., As-is">
                </div>
                <div class="col-span-2">
                    <label for="proposal-landlord-work" class="block text-slate-700 font-medium mb-2">Landlord's Work</label>
                    <textarea id="proposal-landlord-work" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
                <div class="col-span-2">
                    <label for="proposal-tenant-work" class="block text-slate-700 font-medium mb-2">Tenant's Work</label>
                    <textarea id="proposal-tenant-work" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
                <div class="col-span-2 text-right">
                    <button type="submit" id="generate-proposal-button" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600">Generate Proposal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- LOI Modal -->
    <div id="loi-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl relative">
            <button id="close-loi-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Generate Letter of Intent to Purchase</h2>
            <form id="loi-form" class="grid grid-cols-2 gap-4">
                <input type="hidden" id="loi-property-id">
                <div>
                    <label for="loi-date" class="block text-slate-700 font-medium mb-2">Date</label>
                    <input type="date" id="loi-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="loi-seller" class="block text-slate-700 font-medium mb-2">Seller Name</label>
                    <input type="text" id="loi-seller" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div class="col-span-2">
                    <label for="loi-buyer" class="block text-slate-700 font-medium mb-2">Buyer Name</label>
                    <input type="text" id="loi-buyer" value="Restaurant GroundWorks" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="loi-purchase-price" class="block text-slate-700 font-medium mb-2">Purchase Price ($)</label>
                    <input type="number" id="loi-purchase-price" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="loi-deposit" class="block text-slate-700 font-medium mb-2">Earnest Money Deposit ($)</label>
                    <input type="number" id="loi-deposit" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="loi-due-diligence" class="block text-slate-700 font-medium mb-2">Due Diligence Period (days)</label>
                    <input type="number" id="loi-due-diligence" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div>
                    <label for="loi-closing-date" class="block text-slate-700 font-medium mb-2">Closing Date</label>
                    <input type="date" id="loi-closing-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <div class="col-span-2 text-right">
                    <button type="submit" id="generate-loi-button" class="bg-amber-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-amber-600">Generate LOI</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Competitor Modal -->
    <div id="competitor-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl relative">
            <button id="close-competitor-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Competitor Analysis</h2>
            <form id="competitor-form" class="flex items-end space-x-4 mb-4">
                <div>
                    <label for="competitor-query" class="block text-slate-700 font-medium mb-2">Restaurant Name</label>
                    <input type="text" id="competitor-query" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., McDonald's" required>
                </div>
                <div>
                    <label for="competitor-radius" class="block text-slate-700 font-medium mb-2">Radius (miles)</label>
                    <input type="number" id="competitor-radius" value="5" class="w-full px-4 py-2 border border-slate-300 rounded-lg" required>
                </div>
                <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">Search</button>
            </form>
            <div class="grid grid-cols-2 gap-8">
                <div id="competitor-map" class="rounded-lg"></div>
                <div id="competitor-list" class="max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div id="report-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-3xl relative">
            <button id="close-report-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <div id="report-content" class="prose max-w-none">
                <!-- Property details will be injected here -->
            </div>
            <div class="mt-6 text-right">
                <button id="download-pdf-button" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">Download PDF</button>
            </div>
        </div>
    </div>
    
    <!-- Compare Modal -->
    <div id="compare-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-6xl relative">
            <button id="close-compare-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Compare Properties</h2>
            <div id="compare-table-container" class="overflow-x-auto"></div>
            <div class="mt-6 text-right">
                <button id="print-compare-button" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Print</button>
            </div>
        </div>
    </div>
    
    <!-- AI Flyer Generator Modal -->
    <div id="flyer-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl relative">
            <button id="close-flyer-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">AI Marketing Flyer Generator</h2>
            <form id="flyer-form">
                <input type="hidden" id="flyer-property-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-slate-700 font-medium mb-2">Address</label>
                        <input type="text" id="flyer-address" class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100" readonly>
                    </div>
                    <div>
                        <label for="flyer-acres" class="block text-slate-700 font-medium mb-2">Land Area (Acres)</label>
                        <input type="number" step="0.01" id="flyer-acres" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div>
                        <label for="flyer-population-radius" class="block text-slate-700 font-medium mb-2">Population Radius (mi)</label>
                        <input type="number" id="flyer-population-radius" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div class="col-span-2">
                         <label for="flyer-population" class="block text-slate-700 font-medium mb-2">Population</label>
                        <input type="number" id="flyer-population" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                    <div class="col-span-2">
                        <p class="block text-slate-700 font-medium mb-2">Traffic Counts</p>
                        <div class="grid grid-cols-2 gap-2">
                           <input type="text" id="flyer-road1-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Road Name 1">
                           <input type="number" id="flyer-road1-aadt" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="AADT 1">
                           <input type="text" id="flyer-road2-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Road Name 2">
                           <input type="number" id="flyer-road2-aadt" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="AADT 2">
                        </div>
                    </div>
                    <div class="col-span-2">
                        <label for="flyer-notes" class="block text-slate-700 font-medium mb-2">Highlights (one per line)</label>
                        <textarea id="flyer-notes" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Walmart Supercenter outlot"></textarea>
                    </div>
                    <div class="col-span-2">
                        <label for="flyer-photo" class="block text-slate-700 font-medium mb-2">Main Aerial Photo</label>
                        <input type="file" id="flyer-photo" accept="image/*" class="w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required/>
                    </div>
                    <div class="col-span-2">
                        <label for="flyer-photo-inset" class="block text-slate-700 font-medium mb-2">Inset Site Plan Photo</label>
                        <input type="file" id="flyer-photo-inset" accept="image/*" class="w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required/>
                    </div>
                </div>
                <div class="mt-6 text-right">
                    <button type="submit" id="generate-flyer-button" class="bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-emerald-600">Generate Flyer</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Third-party libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    
    <!-- Main Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { firebaseConfig, GEMINI_API_KEY, GOOGLE_MAPS_API_KEY } from './config.js';

        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
        
        // --- INITIALIZE FIREBASE & SERVICES ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const propertiesCollection = collection(db, "properties");
        
        // --- DYNAMICALLY LOAD GOOGLE MAPS SCRIPT ---
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const mainContent = document.getElementById('main-content');
            const logoutButton = document.getElementById('logout-button');
            const propertyForm = document.getElementById('add-property-form');
            const tableBody = document.getElementById('property-table-body');
            const imageModal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            const closeModal = document.getElementById('close-modal');
            const detailsModal = document.getElementById('details-modal');
            const closeDetailsModal = document.getElementById('close-details-modal');
            const selectAllCheckbox = document.getElementById('select-all');
            const exportButton = document.getElementById('export-button');
            const compareButton = document.getElementById('compare-button');
            const proposalModal = document.getElementById('proposal-modal');
            const closeProposalModal = document.getElementById('close-proposal-modal');
            const proposalForm = document.getElementById('proposal-form');
            const loiModal = document.getElementById('loi-modal');
            const closeLoiModal = document.getElementById('close-loi-modal');
            const loiForm = document.getElementById('loi-form');
            const competitorModal = document.getElementById('competitor-modal');
            const closeCompetitorModal = document.getElementById('close-competitor-modal');
            const competitorForm = document.getElementById('competitor-form');
            const reportModal = document.getElementById('report-modal');
            const closeReportModal = document.getElementById('close-report-modal');
            const downloadPdfButton = document.getElementById('download-pdf-button');
            const reportContent = document.getElementById('report-content');
            const compareModal = document.getElementById('compare-modal');
            const closeCompareModal = document.getElementById('close-compare-modal');
            const compareTableContainer = document.getElementById('compare-table-container');
            const printCompareButton = document.getElementById('print-compare-button');
            const searchForm = document.getElementById('search-form');
            const clearSearchButton = document.getElementById('clear-search-button');
            const zoningForm = document.getElementById('zoning-form');
            const zoningResultsContainer = document.getElementById('zoning-results-container');
            const franchiseForm = document.getElementById('franchise-form');
            const franchiseResultsContainer = document.getElementById('franchise-results-container');
            const deedForm = document.getElementById('deed-form');
            const deedResultsContainer = document.getElementById('deed-results-container');
            const deedPrintContainer = document.getElementById('deed-print-container');
            const printDeedAnalysisButton = document.getElementById('print-deed-analysis-button');
            const flyerModal = document.getElementById('flyer-modal');
            const closeFlyerModal = document.getElementById('close-flyer-modal');
            const flyerForm = document.getElementById('flyer-form');
            
            let currentPropertyForAnalysis = null;
            let competitorMap;
            let competitorMarkers = [];

            let properties = [];
            let filteredProperties = [];
            let sortState = { key: 'address', direction: 'asc' };
            let map;
            let geocoder;
            let markers = [];

            // --- AUTHENTICATION LOGIC ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    mainContent.classList.remove('hidden');
                    loadGoogleMapsScript();
                    loadProperties();
                } else {
                    window.location.href = 'login.html';
                }
            });

            logoutButton.addEventListener('click', () => {
                signOut(auth);
            });

            // --- DATA MANAGEMENT ---
            async function loadProperties() {
                const snapshot = await getDocs(propertiesCollection);
                properties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filteredProperties = [...properties];
                renderTable();
                if (window.google) {
                   updateAllMarkers();
                }
            }

            // --- FORMATTING HELPERS ---
            const formatCurrency = (value) => !value || isNaN(value) ? '' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
            const formatCurrencyWithDecimals = (value) => !value || isNaN(value) ? '' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            const formatNumber = (value) => value ? new Intl.NumberFormat('en-US').format(value) : '';
            const formatPercent = (value) => value ? `${(value * 100).toFixed(2)}%` : '0.00%';

            // --- SORTING ---
            function sortProperties() {
                filteredProperties.sort((a, b) => {
                    const valA = getPropertyValue(a, sortState.key);
                    const valB = getPropertyValue(b, sortState.key);

                    if (valA < valB) {
                        return sortState.direction === 'asc' ? -1 : 1;
                    }
                    if (valA > valB) {
                        return sortState.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            function getPropertyValue(prop, key) {
                if (key === 'sqft') {
                    return prop.acres ? prop.acres * 43560 : 0;
                }
                if (key === 'pricePerSqFt') {
                    const sqft = prop.acres ? prop.acres * 43560 : 0;
                    return (prop.price && sqft) ? prop.price / sqft : 0;
                }
                if (key === 'minRent') {
                    const targetValue = prop.price * (1 + (prop.intendedRoi || 0));
                    return targetValue * (prop.capRate || 0);
                }
                if (key === 'dom') {
                    let currentDom = prop.initialDom || 0;
                    if (prop.dateAdded) {
                        const dateAdded = new Date(prop.dateAdded);
                        if (!isNaN(dateAdded.getTime())) {
                            const today = new Date();
                            dateAdded.setHours(0,0,0,0);
                            today.setHours(0,0,0,0);
                            const differenceInTime = today.getTime() - dateAdded.getTime();
                            const daysPassed = Math.floor(differenceInTime / (1000 * 3600 * 24));
                            currentDom += daysPassed;
                        }
                    }
                    return currentDom;
                }
                return prop[key];
            }

            // --- TABLE RENDERING ---
            function renderTable() {
                sortProperties();
                tableBody.innerHTML = '';
                if (filteredProperties.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="18" class="text-center p-8 text-slate-500">No properties match your search criteria.</td></tr>`;
                } else {
                    filteredProperties.forEach(prop => {
                        const row = createTableRow(prop);
                        tableBody.appendChild(row);
                    });
                }
                updateSortIndicators();
            }

            function createTableRow(property) {
                const row = document.createElement('tr');
                row.dataset.id = property.id;
                
                const pricePerSqFt = getPropertyValue(property, 'pricePerSqFt');
                const calculatedSqft = getPropertyValue(property, 'sqft');
                const minRent = getPropertyValue(property, 'minRent');
                const currentDom = getPropertyValue(property, 'dom');

                row.innerHTML = `
                    <td class="table-cell"><input type="checkbox" class="row-checkbox" data-id="${property.id}"></td>
                    <td class="table-cell"><img src="${property.photoUrl || 'https://placehold.co/100x100/e2e8f0/0f172a?text=No+Image'}" class="w-16 h-16 object-cover rounded-md cursor-pointer thumbnail-img" data-full-src="${property.photoUrl}"></td>
                    <td class="table-cell editable-cell" data-key="address">${property.address || ''}</td>
                    <td class="table-cell editable-cell" data-key="city">${property.city || ''}</td>
                    <td class="table-cell editable-cell" data-key="state">${property.state || ''}</td>
                    <td class="table-cell editable-cell" data-key="price">${formatCurrency(property.price)}</td>
                    <td class="table-cell editable-cell" data-key="acres">${property.acres || ''}</td>
                    <td class="table-cell">${formatNumber(calculatedSqft)}</td>
                    <td class="table-cell">${formatCurrencyWithDecimals(pricePerSqFt)}</td>
                    <td class="table-cell">${currentDom}</td>
                    <td class="table-cell editable-cell" data-key="aadt">${formatNumber(property.aadt)}</td>
                    <td class="table-cell editable-cell" data-key="signalizedIntersection">${property.signalizedIntersection || 'No'}</td>
                    <td class="table-cell editable-cell" data-key="intendedRoi">${formatPercent(property.intendedRoi)}</td>
                    <td class="table-cell editable-cell" data-key="capRate">${formatPercent(property.capRate)}</td>
                    <td class="table-cell">${formatCurrency(minRent)}</td>
                    <td class="table-cell editable-cell" data-key="notes">${property.notes || ''}</td>
                    <td class="table-cell editable-cell" data-key="fileLink">${property.fileLink ? `<a href="${property.fileLink}" target="_blank" class="text-indigo-600 hover:underline">View File</a>` : ''}</td>
                    <td class="table-cell text-center whitespace-nowrap">
                        <button class="flyer-btn bg-emerald-500 text-white px-3 py-1 rounded-md text-sm hover:bg-emerald-600 mr-2">Flyer</button>
                        <button class="loi-btn bg-purple-500 text-white px-3 py-1 rounded-md text-sm hover:bg-purple-600 mr-2">LOI</button>
                        <button class="competitors-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2">Competitors</button>
                        <button class="proposal-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 mr-2">Proposal</button>
                        <button class="pdf-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 mr-2">Profile</button>
                        <button class="delete-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                    </td>
                `;
                return row;
            }

            function updateSortIndicators() {
                document.querySelectorAll('.sortable-header').forEach(header => {
                    const key = header.dataset.key;
                    header.innerHTML = header.innerHTML.replace(/ []/, '');
                    if (key === sortState.key) {
                        header.innerHTML += sortState.direction === 'asc' ? ' ' : ' ';
                    }
                });
            }

            // --- EVENT LISTENERS ---
            propertyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = propertyForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = 'Adding...';

                const photoFile = document.getElementById('photo-upload').files[0];
                let photoUrl = '';
                if (photoFile) {
                    const storageRef = ref(storage, `property_images/${Date.now()}_${photoFile.name}`);
                    await uploadBytes(storageRef, photoFile);
                    photoUrl = await getDownloadURL(storageRef);
                }
                
                const file = document.getElementById('file-upload').files[0];
                let fileUrl = '';
                if (file) {
                    const storageRef = ref(storage, `property_files/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    fileUrl = await getDownloadURL(storageRef);
                }

                const newProperty = {
                    address: document.getElementById('address').value.trim(),
                    city: document.getElementById('city').value.trim(),
                    state: document.getElementById('state').value,
                    price: parseFloat(document.getElementById('price').value),
                    acres: parseFloat(document.getElementById('acres').value) || null,
                    initialDom: parseInt(document.getElementById('dom').value) || 0,
                    trafficRoad1: document.getElementById('trafficRoad1').value.trim(),
                    aadt: parseInt(document.getElementById('aadt').value) || null,
                    trafficRoad2: document.getElementById('trafficRoad2').value.trim(),
                    aadt2: parseInt(document.getElementById('aadt2').value) || null,
                    populationRadius: parseInt(document.getElementById('populationRadius').value) || null,
                    population: parseInt(document.getElementById('population').value) || null,
                    signalizedIntersection: document.getElementById('signalized-intersection').value,
                    dateAdded: new Date().toISOString(),
                    notes: document.getElementById('notes').value.trim(),
                    fileLink: fileUrl,
                    intendedRoi: parseFloat(document.getElementById('intendedRoi').value) / 100 || 0,
                    capRate: parseFloat(document.getElementById('capRate').value) / 100 || 0,
                    photoUrl: photoUrl
                };

                try {
                    await addDoc(propertiesCollection, newProperty);
                    propertyForm.reset();
                    loadProperties();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Failed to add property.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Add Property';
                }
            });

            tableBody.addEventListener('click', async (e) => {
                const row = e.target.closest('tr');
                if (!row) return;

                const id = row.dataset.id;
                
                if (e.target.classList.contains('delete-btn')) {
                    if (!confirm("Are you sure you want to delete this property?")) return;
                    try {
                        await deleteDoc(doc(db, "properties", id));
                        loadProperties();
                    } catch (error) {
                        console.error("Error removing document: ", error);
                        alert("Failed to delete property.");
                    }
                } else if (e.target.classList.contains('pdf-btn')) {
                    const property = properties.find(p => p.id === id);
                    if (property) showReportModal(property);
                } else if (e.target.classList.contains('proposal-btn')) {
                    const property = properties.find(p => p.id === id);
                    if (property) openProposalModal(property);
                } else if (e.target.classList.contains('loi-btn')) {
                    const property = properties.find(p => p.id === id);
                    if (property) openLoiModal(property);
                } else if (e.target.classList.contains('competitors-btn')) {
                    const property = properties.find(p => p.id === id);
                    if (property) openCompetitorModal(property);
                } else if (e.target.classList.contains('flyer-btn')) {
                    const property = properties.find(p => p.id === id);
                    if (property) openFlyerModal(property);
                } else if (e.target.classList.contains('thumbnail-img')) {
                    const fullSrc = e.target.dataset.fullSrc;
                    if (fullSrc) {
                        modalImage.src = fullSrc;
                        imageModal.classList.remove('hidden');
                    }
                }

                const cell = e.target.closest('.editable-cell');
                if (!cell || cell.isContentEditable) return;
                cell.setAttribute('contenteditable', 'true');
                cell.focus();
                document.execCommand('selectAll', false, null);
            });

            closeModal.addEventListener('click', () => imageModal.classList.add('hidden'));
            closeDetailsModal.addEventListener('click', () => detailsModal.classList.add('hidden'));
            closeProposalModal.addEventListener('click', () => proposalModal.classList.add('hidden'));
            closeLoiModal.addEventListener('click', () => loiModal.classList.add('hidden'));
            closeCompetitorModal.addEventListener('click', () => competitorModal.classList.add('hidden'));
            closeReportModal.addEventListener('click', () => reportModal.classList.add('hidden'));
            closeCompareModal.addEventListener('click', () => compareModal.classList.add('hidden'));
            closeFlyerModal.addEventListener('click', () => flyerModal.classList.add('hidden'));

            tableBody.addEventListener('focusout', async (e) => {
                const cell = e.target.closest('.editable-cell');
                if (!cell || !cell.isContentEditable) return;
                cell.setAttribute('contenteditable', 'false');

                const id = cell.closest('tr').dataset.id;
                const key = cell.dataset.key;
                let value = cell.textContent;

                const propertyIndex = properties.findIndex(p => p.id === id);
                const originalValue = properties[propertyIndex][key];

                const numericKeys = ['price', 'acres', 'initialDom', 'aadt', 'aadt2', 'population', 'populationRadius'];
                const percentKeys = ['intendedRoi', 'capRate'];

                if (numericKeys.includes(key)) {
                    value = parseFloat(value.replace(/[^0-9.]/g, '')) || 0;
                } else if (percentKeys.includes(key)) {
                    value = (parseFloat(value.replace(/[^0-9.%]/g, '')) || 0) / 100;
                }
                
                if (value === originalValue) {
                    renderTable();
                    return;
                }
                
                cell.innerHTML = '<i>Saving...</i>';

                try {
                    const propertyRef = doc(db, "properties", id);
                    await updateDoc(propertyRef, { [key]: value });
                    setTimeout(() => {
                        loadProperties(); 
                    }, 500);
                } catch (error) {
                    console.error("Error updating document: ", error);
                    alert("Failed to update property. Reverting change.");
                    loadProperties();
                }
            });
            
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const key = header.dataset.key;
                    if (sortState.key === key) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.key = key;
                        sortState.direction = 'asc';
                    }
                    renderTable();
                });
            });

            selectAllCheckbox.addEventListener('change', (e) => {
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
            });

            exportButton.addEventListener('click', () => {
                const selectedIds = [...document.querySelectorAll('.row-checkbox:checked')].map(cb => cb.dataset.id);
                if (selectedIds.length === 0) {
                    alert("Please select at least one property to export.");
                    return;
                }
                const selectedProperties = properties.filter(p => selectedIds.includes(p.id));
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Address,City,State,Asking Price,Acres,Traffic Count,Signalized Intersection,Notes\n";
                selectedProperties.forEach(prop => {
                    const row = [prop.address, prop.city, prop.state, prop.price, prop.acres, prop.aadt, prop.signalizedIntersection, `"${prop.notes}"`].join(",");
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "properties.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            compareButton.addEventListener('click', () => {
                const selectedIds = [...document.querySelectorAll('.row-checkbox:checked')].map(cb => cb.dataset.id);
                if (selectedIds.length < 2) {
                    alert("Please select at least two properties to compare.");
                    return;
                }
                const selectedProperties = properties.filter(p => selectedIds.includes(p.id));
                openCompareModal(selectedProperties);
            });
            
            searchForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const searchAddress = document.getElementById('search-address').value.toLowerCase();
                const searchCity = document.getElementById('search-city').value.toLowerCase();
                const searchState = document.getElementById('search-state').value.toLowerCase();
                const minPrice = parseFloat(document.getElementById('search-min-price').value);
                const maxPrice = parseFloat(document.getElementById('search-max-price').value);
                const minAcres = parseFloat(document.getElementById('search-min-acres').value);
                const maxAcres = parseFloat(document.getElementById('search-max-acres').value);
                
                filteredProperties = properties.filter(p => {
                    const addressMatch = !searchAddress || (p.address && p.address.toLowerCase().includes(searchAddress));
                    const cityMatch = !searchCity || (p.city && p.city.toLowerCase().includes(searchCity));
                    const stateMatch = !searchState || (p.state && p.state.toLowerCase().includes(searchState));
                    const minPriceMatch = isNaN(minPrice) || p.price >= minPrice;
                    const maxPriceMatch = isNaN(maxPrice) || p.price <= maxPrice;
                    const minAcresMatch = isNaN(minAcres) || p.acres >= minAcres;
                    const maxAcresMatch = isNaN(maxAcres) || p.acres <= maxAcres;
                    
                    return addressMatch && cityMatch && stateMatch && minPriceMatch && maxPriceMatch && minAcresMatch && maxAcresMatch;
                });
                
                renderTable();
                updateAllMarkers();
            });

            clearSearchButton.addEventListener('click', () => {
                searchForm.reset();
                filteredProperties = [...properties];
                renderTable();
                updateAllMarkers();
            });

            // --- GOOGLE MAPS INTEGRATION ---
            window.initMap = function() {
                geocoder = new google.maps.Geocoder();
                const usa = { lat: 39.8283, lng: -98.5795 };
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 4,
                    center: usa,
                });
                
                google.maps.event.addListener(map, 'click', (e) => {
                    if(e.target?.classList.contains('details-btn')) {
                        const id = e.target.dataset.propertyId;
                        const property = properties.find(p => p.id === id);
                        if(property) {
                            showPropertyDetailsModal(property);
                        }
                    }
                });
                updateAllMarkers();
            }
            
            function addMarkerToMap(property) {
                const fullAddress = `${property.address}, ${property.city}, ${property.state}`;
                geocoder.geocode({ 'address': fullAddress }, (results, status) => {
                    if (status === 'OK') {
                        document.getElementById('map-error').classList.add('hidden');
                        const location = results[0].geometry.location;
                        property.location = { lat: location.lat(), lng: location.lng() };
                        
                        const marker = new google.maps.Marker({
                            map: map,
                            position: location,
                            title: property.address,
                        });
                        
                        let infoWindowContent = `<div class="p-1">`;
                        if (property.photoUrl) {
                            infoWindowContent += `<img src="${property.photoUrl}" alt="Property photo" class="w-32 h-24 object-cover rounded-md mb-2">`;
                        }
                        infoWindowContent += `<strong>${property.address}</strong><br>${formatCurrency(property.price)}<br><button class="details-btn bg-indigo-500 text-white px-2 py-1 mt-2 rounded-md text-xs" data-property-id="${property.id}">Details</button></div>`;

                        const infoWindow = new google.maps.InfoWindow({
                            content: infoWindowContent
                        });

                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        
                        google.maps.event.addListener(infoWindow, 'domready', () => {
                            const detailsBtn = document.querySelector(`.details-btn[data-property-id="${property.id}"]`);
                            if (detailsBtn) {
                                detailsBtn.addEventListener('click', () => {
                                    showPropertyDetailsModal(property);
                                });
                            }
                        });

                        markers.push({ id: property.id, marker: marker });
                    } else {
                        console.error('Geocode was not successful for the following reason: ' + status);
                        document.getElementById('map-error').classList.remove('hidden');
                    }
                });
            }

            function updateAllMarkers() {
                 if (!window.google || !map) return;
                markers.forEach(({ marker }) => marker.setMap(null));
                markers = [];
                filteredProperties.forEach(addMarkerToMap);
            }
            
            function showPropertyDetailsModal(property) {
                document.getElementById('modal-address').textContent = `${property.address}, ${property.city}, ${property.state}`;
                document.getElementById('modal-details-image').src = property.photoUrl || 'https://placehold.co/400x200/e2e8f0/0f172a?text=No+Image';
                document.getElementById('modal-price').textContent = formatCurrency(property.price);
                document.getElementById('modal-acres').textContent = property.acres || 'N/A';
                document.getElementById('modal-aadt').textContent = formatNumber(property.aadt);
                document.getElementById('modal-notes').textContent = property.notes || 'N/A';
                detailsModal.classList.remove('hidden');
            }
            
            function showReportModal(property) {
                const calculatedSqft = getPropertyValue(property, 'sqft');
                reportContent.innerHTML = `
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">${property.address}, ${property.city}, ${property.state}</h2>
                    <img src="${property.photoUrl || 'https://placehold.co/400x200/e2e8f0/0f172a?text=No+Image'}" alt="Property photo" class="w-full h-64 object-cover rounded-md mb-4">
                    <div class="grid grid-cols-2 gap-4 text-slate-700">
                        <p><strong>Asking Price:</strong> ${formatCurrency(property.price)}</p>
                        <p><strong>Acres:</strong> ${property.acres || 'N/A'}</p>
                        <p><strong>Sq. Footage (Calc.):</strong> ${formatNumber(calculatedSqft)}</p>
                        <p><strong>Traffic Count (AADT):</strong> ${formatNumber(property.aadt)}</p>
                        <p><strong>Notes:</strong> ${property.notes || 'N/A'}</p>
                    </div>
                `;
                downloadPdfButton.onclick = () => generatePDF(property);
                reportModal.classList.remove('hidden');
            }

            // --- PDF GENERATION ---
            async function generatePDF(property) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text("Property Profile", 105, 20, { align: 'center' });

                    doc.setFontSize(16);
                    doc.setFont("helvetica", "normal");
                    doc.text(`${property.address || ''}, ${property.city || ''}, ${property.state || ''}`, 105, 30, { align: 'center' });

                    if (property.photoUrl) {
                        try {
                            const response = await fetch(`https://cors-anywhere.herokuapp.com/${property.photoUrl}`);
                            const blob = await response.blob();
                            const reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onloadend = () => {
                                const base64data = reader.result;
                                doc.addImage(base64data, 'JPEG', 15, 40, 180, 90);
                                addPdfContent(doc, property);
                                doc.save(`${(property.address || 'property_profile').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                            };
                        } catch (e) {
                            console.error("CORS issue or image fetch failed, skipping image.", e);
                            addPdfContent(doc, property);
                            doc.save(`${(property.address || 'property_profile').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                        }

                    } else {
                        doc.setFillColor(230, 230, 230);
                        doc.rect(15, 40, 180, 90, 'F');
                        doc.setTextColor(150, 150, 150);
                        doc.text("No Image Available", 105, 85, { align: 'center' });
                        addPdfContent(doc, property);
                        doc.save(`${(property.address || 'property_profile').replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                    }
                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    alert("An error occurred while generating the PDF. Check the console for details.");
                }
            }
            
            function addPdfContent(doc, property) {
                doc.setTextColor(0, 0, 0);
                let y = 150;
                const addLine = (label, value) => {
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(label, 15, y);
                    doc.setFont("helvetica", "normal");
                    doc.text(String(value || ''), 80, y);
                    y += 10;
                };

                addLine("Asking Price:", formatCurrency(property.price));
                addLine("Acres:", property.acres);
                addLine("Sq. Footage (Calc.):", formatNumber(getPropertyValue(property, 'sqft')));
                addLine("Price per SF:", formatCurrencyWithDecimals(getPropertyValue(property, 'pricePerSqFt')));
                addLine("Traffic Count (AADT):", formatNumber(property.aadt));
                addLine("Signalized Intersection:", property.signalizedIntersection);
                addLine("Intended ROI:", formatPercent(property.intendedRoi));
                addLine("Capitalization Rate:", formatPercent(property.capRate));
                
                const minRent = getPropertyValue(property, 'minRent');
                addLine("Minimum Rental Rate:", formatCurrency(minRent));
                
                doc.setFont("helvetica", "bold");
                doc.text("Notes:", 15, y);
                y += 10;
                doc.setFont("helvetica", "normal");
                const notes = doc.splitTextToSize(property.notes || 'N/A', 180);
                doc.text(notes, 15, y);
            }
            
            // --- PROPOSAL GENERATOR ---
            function openProposalModal(property) {
                document.getElementById('proposal-property-id').value = property.id;
                document.getElementById('proposal-date').valueAsDate = new Date();
                proposalModal.classList.remove('hidden');
            }

            proposalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('generate-proposal-button');
                button.disabled = true;
                button.textContent = 'Generating...';

                const propertyId = document.getElementById('proposal-property-id').value;
                const property = properties.find(p => p.id === propertyId);
                
                const proposalData = {
                    date: document.getElementById('proposal-date').value,
                    tenant: document.getElementById('proposal-tenant').value,
                    tenantAddress: document.getElementById('proposal-tenant-address').value,
                    leaseTerm: document.getElementById('proposal-lease-term').value,
                    annualRent: document.getElementById('proposal-annual-rent').value,
                    expenseStructure: document.getElementById('proposal-expense-structure').value,
                    renewalOptions: document.getElementById('proposal-renewal-options').value,
                    deliveryCondition: document.getElementById('proposal-delivery-condition').value,
                    landlordWork: document.getElementById('proposal-landlord-work').value,
                    tenantWork: document.getElementById('proposal-tenant-work').value,
                    address: `${property.address}, ${property.city}, ${property.state}`,
                    acres: property.acres,
                    aadt: property.aadt,
                };

                const prompt = `Write a formal ground lease proposal letter.
                Date: ${proposalData.date}
                Landlord: Restaurant GroundWorks
                Tenant: ${proposalData.tenant}
                Tenant Address: ${proposalData.tenantAddress}
                Property: ${proposalData.address}
                Lease Term: ${proposalData.leaseTerm} years
                Annual Rent: $${proposalData.annualRent}
                Expense Structure: ${proposalData.expenseStructure}
                Renewal Options: ${proposalData.renewalOptions}
                Delivery Condition: ${proposalData.deliveryCondition}
                Landlord's Work: ${proposalData.landlordWork}
                Tenant's Work: ${proposalData.tenantWork}
                Property Size: ${proposalData.acres} Acres
                Property Traffic Count: ${proposalData.aadt} AADT
                The letter should be from "Ryan Alexander, Principal" of Restaurant GroundWorks.
                Format it as a professional business letter.`;

                try {
                    const rawText = await callGeminiWithExponentialBackoff(prompt);
                    generateProposalPDF(rawText);
                } catch (error) {
                    console.error("Error generating proposal:", error);
                    alert("Failed to generate proposal.");
                } finally {
                    button.disabled = false;
                    button.textContent = 'Generate Proposal';
                    proposalModal.classList.add('hidden');
                }
            });
            
            // --- LOI GENERATOR ---
            function openLoiModal(property) {
                document.getElementById('loi-property-id').value = property.id;
                document.getElementById('loi-date').valueAsDate = new Date();
                loiModal.classList.remove('hidden');
            }

            loiForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('generate-loi-button');
                button.disabled = true;
                button.textContent = 'Generating...';

                const propertyId = document.getElementById('loi-property-id').value;
                const property = properties.find(p => p.id === propertyId);
                
                const loiData = {
                    date: document.getElementById('loi-date').value,
                    seller: document.getElementById('loi-seller').value,
                    buyer: document.getElementById('loi-buyer').value,
                    purchasePrice: document.getElementById('loi-purchase-price').value,
                    deposit: document.getElementById('loi-deposit').value,
                    dueDiligence: document.getElementById('loi-due-diligence').value,
                    closingDate: document.getElementById('loi-closing-date').value,
                    address: `${property.address}, ${property.city}, ${property.state}`,
                };

                const prompt = `Write a formal Letter of Intent to Purchase real estate.
                Date: ${loiData.date}
                Seller: ${loiData.seller}
                Buyer: ${loiData.buyer}
                Property: ${loiData.address}
                Purchase Price: $${loiData.purchasePrice}
                Earnest Money Deposit: $${loiData.deposit}
                Due Diligence Period: ${loiData.dueDiligence} days
                Closing Date: ${loiData.closingDate}
                The letter should be from "Ryan Alexander, Principal" of ${loiData.buyer}.
                Format it as a professional business letter.`;

                try {
                    const rawText = await callGeminiWithExponentialBackoff(prompt);
                    generateLoiPDF(rawText);
                } catch (error) {
                    console.error("Error generating LOI:", error);
                    alert("Failed to generate LOI.");
                } finally {
                    button.disabled = false;
                    button.textContent = 'Generate LOI';
                    loiModal.classList.add('hidden');
                }
            });

            function generateLoiPDF(text) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("Restaurant GroundWorks", 105, 20, { align: 'center' });
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.text("Letter of Intent to Purchase", 105, 28, { align: 'center' });
                    doc.setLineWidth(0.5);
                    doc.line(15, 35, 195, 35);

                    const lines = doc.splitTextToSize(text, 180);
                    doc.text(lines, 15, 50);

                    doc.save('Letter_of_Intent.pdf');
                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    alert("An error occurred while generating the PDF.");
                }
            }
            
            // --- COMPETITOR ANALYSIS ---
            function openCompetitorModal(property) {
                currentPropertyForAnalysis = property;
                competitorModal.classList.remove('hidden');
                
                if (!competitorMap) {
                    competitorMap = new google.maps.Map(document.getElementById("competitor-map"), {
                        zoom: 12,
                        center: property.location,
                    });
                } else {
                    competitorMap.setCenter(property.location);
                }
                
                clearCompetitorMarkers();
                new google.maps.Marker({
                    map: competitorMap,
                    position: property.location,
                    title: "Subject Property",
                    icon: {
                        url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                    }
                });
            }

            competitorForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('competitor-query').value;
                const radius = parseFloat(document.getElementById('competitor-radius').value) * 1609.34; // Convert miles to meters

                const request = {
                    location: currentPropertyForAnalysis.location,
                    radius: radius,
                    keyword: query
                };

                const service = new google.maps.places.PlacesService(competitorMap);
                service.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        clearCompetitorMarkers();
                        displayCompetitorList(results);
                        results.forEach(place => createCompetitorMarker(place));
                    }
                });
            });
            
            function clearCompetitorMarkers() {
                competitorMarkers.forEach(marker => marker.setMap(null));
                competitorMarkers = [];
                document.getElementById('competitor-list').innerHTML = '';
            }
            
            function createCompetitorMarker(place) {
                const marker = new google.maps.Marker({
                    map: competitorMap,
                    position: place.geometry.location,
                    title: place.name
                });
                competitorMarkers.push(marker);
            }
            
            function displayCompetitorList(places) {
                const list = document.getElementById('competitor-list');
                places.forEach(place => {
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(currentPropertyForAnalysis.location),
                        place.geometry.location
                    );
                    const distanceInMiles = (distance / 1609.34).toFixed(2);
                    
                    const item = document.createElement('div');
                    item.className = 'p-2 border-b';
                    item.innerHTML = `<strong>${place.name}</strong><br>${place.vicinity}<br><em>${distanceInMiles} miles away</em>`;
                    list.appendChild(item);
                });
            }
            
            async function callGeminiWithExponentialBackoff(prompt, useSearch = false, maxRetries = 7) {
                let delay = 2000; 
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const model = useSearch ? 'gemini-2.5-flash-preview-05-20' : 'gemini-1.5-flash-latest';
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                        
                        const payload = {
                            contents: [{ parts: [{ text: prompt }] }],
                        };

                        if (useSearch) {
                            payload.tools = [{ "google_search": {} }];
                        }

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            throw new Error('Rate limited');
                        }

                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                        }
                        
                        const result = await response.json();
                        if (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0]) {
                           return result.candidates[0].content.parts[0].text;
                        } else {
                           throw new Error("Invalid response structure from API.");
                        }

                    } catch (error) {
                        console.warn(`Attempt ${i + 1} failed: ${error.message}. Retrying in ${delay}ms...`);
                        if (i === maxRetries - 1) {
                            throw error;
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay = delay * 2 + Math.random() * 1000;
                    }
                }
            }

            function generateProposalPDF(text) {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("Restaurant GroundWorks", 105, 20, { align: 'center' });
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    doc.text("Lease Proposal", 105, 28, { align: 'center' });
                    doc.setLineWidth(0.5);
                    doc.line(15, 35, 195, 35);

                    const lines = doc.splitTextToSize(text, 180);
                    doc.text(lines, 15, 50);

                    doc.save('Lease_Proposal.pdf');
                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    alert("An error occurred while generating the PDF.");
                }
            }
            
            function openCompareModal(selectedProperties) {
                let tableHTML = '<table class="w-full text-left">';
                
                tableHTML += '<thead><tr class="bg-slate-100">';
                tableHTML += '<th class="table-cell font-semibold">Feature</th>';
                selectedProperties.forEach(p => {
                    tableHTML += `<th class="table-cell font-semibold">${p.address}</th>`;
                });
                tableHTML += '</tr></thead>';

                tableHTML += '<tbody>';
                const keysToCompare = [
                    { key: 'price', label: 'Asking Price', format: formatCurrency },
                    { key: 'acres', label: 'Acres' },
                    { key: 'sqft', label: 'Sq. Footage (Calc.)', format: formatNumber },
                    { key: 'pricePerSqFt', label: 'Price per SF', format: formatCurrencyWithDecimals },
                    { key: 'aadt', label: 'Traffic Count', format: formatNumber },
                    { key: 'signalizedIntersection', label: 'Signalized Intersection' },
                    { key: 'minRent', label: 'Min. Rental Rate', format: formatCurrency },
                    { key: 'notes', label: 'Notes' }
                ];

                keysToCompare.forEach(item => {
                    tableHTML += '<tr>';
                    tableHTML += `<td class="table-cell font-semibold">${item.label}</td>`;
                    selectedProperties.forEach(p => {
                        const value = getPropertyValue(p, item.key);
                        const formattedValue = item.format ? item.format(value) : (value || 'N/A');
                        tableHTML += `<td class="table-cell">${formattedValue}</td>`;
                    });
                    tableHTML += '</tr>';
                });

                tableHTML += '</tbody></table>';
                
                compareTableContainer.innerHTML = tableHTML;
                compareModal.classList.remove('hidden');
            }
            
            printCompareButton.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.autoTable({ html: '#compare-table-container table' });
                doc.save('property-comparison.pdf');
            });
            
            zoningForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('get-zoning-info-button');
                button.disabled = true;
                button.textContent = 'Analyzing...';
                zoningResultsContainer.classList.add('hidden');

                const municipality = document.getElementById('zoning-municipality').value;
                const designation = document.getElementById('zoning-designation').value;
                
                const prompt = `Provide a summary of the zoning regulations for a property in ${municipality} with a zoning designation of ${designation}. The summary should include: 1. **Permitted Uses:** A list of the primary uses allowed. 2. **Development Requirements:** Key details like minimum lot size, setbacks, and maximum building height. 3. **Parking Requirements:** The required number of parking spaces. 4. **Signage:** Rules for on-premise signs. Format the response with clear headings and bullet points.`;

                try {
                    const rawText = await callGeminiWithExponentialBackoff(prompt, true);
                    zoningResultsContainer.innerHTML = rawText.replace(/\n/g, '<br>');
                    zoningResultsContainer.classList.remove('hidden');
                } catch (error) {
                    console.error("Error getting zoning info:", error);
                    zoningResultsContainer.innerHTML = '<p class="text-red-500">Failed to retrieve zoning information.</p>';
                    zoningResultsContainer.classList.remove('hidden');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Get Zoning Info';
                }
            });

            franchiseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('get-franchise-info-button');
                button.disabled = true;
                button.textContent = 'Analyzing...';
                franchiseResultsContainer.classList.add('hidden');

                const franchiseName = document.getElementById('franchise-name').value;

                const prompt = `Provide a detailed summary of the real estate site selection requirements for the franchise "${franchiseName}". The summary should include, but not be limited to:
                1.  **Lot Size:** Minimum and preferred acreage or square footage.
                2.  **Building Size:** Typical square footage for their standard prototype.
                3.  **Traffic Counts:** Minimum daily traffic (AADT) required.
                4.  **Demographics:** Target population density, median income, and household data within a 1, 3, and 5-mile radius.
                5.  **Visibility & Access:** Requirements for corner locations, signalized intersections, and ingress/egress.
                6.  **Zoning:** Preferred commercial zoning designations.
                7.  **Co-tenancy:** Desired nearby businesses or traffic generators.
                Format the response with clear headings and bullet points. If specific data is not publicly available, provide a typical range for a franchise of this type and size.`;

                try {
                    const rawText = await callGeminiWithExponentialBackoff(prompt, true);
                    franchiseResultsContainer.innerHTML = rawText.replace(/\n/g, '<br>');
                    franchiseResultsContainer.classList.remove('hidden');
                } catch (error) {
                    console.error("Error getting franchise info:", error);
                    franchiseResultsContainer.innerHTML = '<p class="text-red-500">Failed to retrieve franchise site requirements.</p>';
                    franchiseResultsContainer.classList.remove('hidden');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Get Site Requirements';
                }
            });
            
            // --- DEED ANALYZER ---
            async function extractTextFromDocx(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const arrayBuffer = event.target.result;
                            const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                            resolve(result.value);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsArrayBuffer(file);
                });
            }

            deedForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('analyze-deed-button');
                const deedUpload = document.getElementById('deed-upload');
                const file = deedUpload.files[0];

                const validTypes = ['application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                if (!file || !validTypes.includes(file.type)) {
                    alert("Please upload a valid Word document (.doc or .docx).");
                    return;
                }
                
                button.disabled = true;
                button.textContent = 'Analyzing...';
                deedResultsContainer.classList.add('hidden');
                deedResultsContainer.innerHTML = '';
                deedPrintContainer.classList.add('hidden');

                try {
                    const docxText = await extractTextFromDocx(file);
                    
                    const prompt = `Please act as an expert real estate paralegal. Review the following text extracted from a legal document and identify and summarize any and all deed restrictions. These could include restrictions on land use, building type, setbacks, minimum square footage, architectural styles, or any other covenants that limit the owner's use of the property. If no restrictions are found, please state that clearly. Here is the text: \n\n${docxText}`;
                    
                    const rawText = await callGeminiWithExponentialBackoff(prompt, true);
                    deedResultsContainer.innerHTML = rawText.replace(/\n/g, '<br>');
                    deedResultsContainer.classList.remove('hidden');
                    deedPrintContainer.classList.remove('hidden');

                } catch (error) {
                    console.error("Error analyzing deed:", error);
                    deedResultsContainer.innerHTML = '<p class="text-red-500">Failed to analyze the document. The Word file might be corrupted.</p>';
                    deedResultsContainer.classList.remove('hidden');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Analyze Document';
                }
            });
            
            printDeedAnalysisButton.addEventListener('click', () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const resultsContainer = document.getElementById('deed-results-container');
                    const text = resultsContainer.innerHTML.replace(/<br\s*[\/]?>/gi, "\n");
                    
                    doc.setFontSize(18);
                    doc.setFont("helvetica", "bold");
                    doc.text("AI Deed Restriction Analysis", 105, 20, { align: 'center' });
                    doc.setLineWidth(0.5);
                    doc.line(15, 25, 195, 25);

                    doc.setFontSize(12);
                    doc.setFont("helvetica", "normal");
                    const lines = doc.splitTextToSize(text, 180);
                    doc.text(lines, 15, 40);

                    doc.save('Deed_Restriction_Analysis.pdf');
                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    alert("An error occurred while generating the PDF.");
                }
            });
            
            // --- FLYER GENERATOR ---
            function openFlyerModal(property) {
                document.getElementById('flyer-property-id').value = property.id;
                document.getElementById('flyer-address').value = `${property.address}, ${property.city}, ${property.state}`;
                document.getElementById('flyer-acres').value = property.acres || '';
                document.getElementById('flyer-population-radius').value = property.populationRadius || '';
                document.getElementById('flyer-population').value = property.population || '';
                document.getElementById('flyer-road1-name').value = property.trafficRoad1 || '';
                document.getElementById('flyer-road1-aadt').value = property.aadt || '';
                document.getElementById('flyer-road2-name').value = property.trafficRoad2 || '';
                document.getElementById('flyer-road2-aadt').value = property.aadt2 || '';
                flyerModal.classList.remove('hidden');
            }

            flyerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const button = document.getElementById('generate-flyer-button');
                button.disabled = true;
                button.textContent = 'Generating...';

                const flyerData = {
                    address: document.getElementById('flyer-address').value,
                    acres: document.getElementById('flyer-acres').value,
                    populationRadius: document.getElementById('flyer-population-radius').value,
                    population: document.getElementById('flyer-population').value,
                    road1Name: document.getElementById('flyer-road1-name').value,
                    road1Aadt: document.getElementById('flyer-road1-aadt').value,
                    road2Name: document.getElementById('flyer-road2-name').value,
                    road2Aadt: document.getElementById('flyer-road2-aadt').value,
                    notes: document.getElementById('flyer-notes').value,
                };
                
                const mainPhotoFile = document.getElementById('flyer-photo').files[0];
                const insetPhotoFile = document.getElementById('flyer-photo-inset').files[0];

                try {
                    await generateFlyerPDF(flyerData, mainPhotoFile, insetPhotoFile);
                } catch (error) {
                    console.error("Error generating flyer:", error);
                    alert("Failed to generate flyer. See console for details.");
                } finally {
                    button.disabled = false;
                    button.textContent = 'Generate Flyer';
                    flyerModal.classList.add('hidden');
                }
            });

            async function generateFlyerPDF(data, imageFile, insetImageFile) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'letter');

                const mainImageBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(imageFile);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });

                const insetImageBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(insetImageFile);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
                
                const logoBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAsAeADASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAn/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/EABQRAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhEDEQA/AKpgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//2Q==';

                // --- Add Main Image ---
                const imgWidth = doc.internal.pageSize.getWidth();
                doc.addImage(mainImageBase64, 'JPEG', 0, 0, imgWidth, 400);

                // --- Blue Banner ---
                doc.setFillColor(15, 75, 146);
                doc.rect(0, 400, imgWidth, 50, 'F');
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('GROUND LEASE OPPORTUNITY', 20, 435);
                
                let yPos = 480;

                // --- Left Column (Property Details) ---
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(data.address, 20, yPos);
                yPos += 25;
                
                doc.setFontSize(11);
                
                if (data.acres) {
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${data.acres} Acres`, 20, yPos);
                    yPos += 20;
                    doc.setFont('helvetica', 'normal');
                }
                
                if (data.notes) {
                    const notesArray = data.notes.split('\n');
                    notesArray.forEach(note => {
                        if (note.trim()) {
                           doc.text(` ${note.trim()}`, 20, yPos);
                           yPos += 15;
                        }
                    });
                }
                
                yPos += 25;

                // --- Traffic and Population ---
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('TRAFFIC COUNTS', 20, yPos);
                yPos += 15;
                doc.setFont('helvetica', 'normal');
                if(data.road1Name && data.road1Aadt) doc.text(`${data.road1Name}`, 20, yPos);
                if(data.road1Aadt) doc.text(`${formatNumber(data.road1Aadt)} AADT`, 150, yPos);
                yPos += 15;
                if(data.road2Name && data.road2Aadt) doc.text(`${data.road2Name}`, 20, yPos);
                if(data.road2Aadt) doc.text(`${formatNumber(data.road2Aadt)} AADT`, 150, yPos);

                yPos += 30;

                doc.setFont('helvetica', 'bold');
                doc.text('POPULATION', 20, yPos);
                yPos += 15;
                doc.setFont('helvetica', 'normal');
                if(data.populationRadius && data.population) doc.text(`${data.populationRadius} Mile Radius`, 20, yPos);
                if(data.population) doc.text(`${formatNumber(data.population)}`, 150, yPos);

                // --- Right Column (Inset Image) ---
                doc.addImage(insetImageBase64, 'JPEG', 350, 470, 240, 200);

                // --- Footer / Contact Info ---
                const pageHeight = doc.internal.pageSize.getHeight();
                const footerY = pageHeight - 80;
                
                doc.addImage(logoBase64, 'JPEG', 20, footerY, 150, 50);

                const contactX = doc.internal.pageSize.getWidth() - 200;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text("Ryan Alexander", contactX, footerY + 15);
                doc.setFont('helvetica', 'normal');
                doc.text("Principal", contactX + 85, footerY + 15);
                doc.text("317.403.2819", contactX, footerY + 30);
                doc.setTextColor(4, 120, 87);
                doc.text("ryan@groundleasegroup.com", contactX, footerY + 45);

                doc.save('Marketing_Flyer.pdf');
            }
        });
    </script>
</body>
</html>

