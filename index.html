<!DOCTYPE html>
<html lang="en">
<head>
    <!-- <link rel="apple-touch-icon" href="icon.png?v=2"> -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GroundWorks">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ground Control | Ground Lease Group</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .drag-card:hover { transform: translateY(-2px); }
        .fc-event { cursor: pointer; border: none; }
        .fc-daygrid-event { font-size: 0.85rem; padding: 2px 4px; border-radius: 4px; }
        .fc-toolbar-title { font-size: 1.25rem !important; font-weight: 700; color: #1e293b; }
        .fc-button-primary { background-color: #0f172a !important; border-color: #0f172a !important; }
        .fc-button-primary:hover { background-color: #334155 !important; border-color: #334155 !important; }
        .fc-button-active { background-color: #059669 !important; border-color: #059669 !important; }
        
        /* Login Overlay Transition */
        #login-overlay { transition: opacity 0.5s ease-in-out, visibility 0.5s; }
        #login-overlay.hidden-overlay { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Diagnostics Panel */
        #diagnostics-panel {
            font-family: monospace;
            font-size: 11px;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 h-screen flex flex-col overflow-hidden">

    <!-- DIAGNOSTICS PANEL (For Debugging) -->
    <div id="diagnostics-panel" class="fixed bottom-4 right-4 z-[200] bg-slate-900 text-slate-200 p-4 rounded-lg shadow-xl w-80 max-h-64 overflow-y-auto hidden md:block opacity-90 hover:opacity-100 transition-opacity">
        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
            <span class="font-bold text-emerald-400">System Diagnostics</span>
            <button onclick="document.getElementById('diagnostics-panel').style.display='none'" class="text-slate-500 hover:text-white">&times;</button>
        </div>
        <div id="log-container" class="space-y-1">
            <div id="init-msg" class="text-slate-500">Waiting for system init...</div>
        </div>
    </div>

    <!-- GLOBAL ERROR HANDLER (Must be before main script) -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            var container = document.getElementById('log-container');
            var initMsg = document.getElementById('init-msg');
            if(initMsg) initMsg.style.display = 'none';
            
            var div = document.createElement('div');
            div.style.color = '#ef4444'; // Red-500
            div.style.fontWeight = 'bold';
            div.style.borderTop = '1px solid #7f1d1d';
            div.style.paddingTop = '4px';
            div.style.marginTop = '4px';
            div.innerText = "CRITICAL ERROR: " + msg + " (Line " + line + ")";
            container.appendChild(div);
            return false;
        };
    </script>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-8">
                <div class="flex flex-col items-center mb-6">
                    <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600 mb-3">
                        <i data-lucide="building" width="24"></i>
                    </div>
                    <h1 class="text-2xl font-extrabold text-slate-900">GroundWorks</h1>
                    <p class="text-slate-500 text-sm mt-1">Retail Lease Management System</p>
                </div>

                <form id="login-form" class="space-y-4">
                    <div id="login-error" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm border border-red-100 flex items-start gap-2">
                        <i data-lucide="alert-circle" width="16" class="mt-0.5 shrink-0"></i>
                        <span id="login-error-text">Error message</span>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Email Address</label>
                        <input type="email" id="login-email" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" placeholder="name@company.com" required>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all" placeholder="••••••••" required>
                    </div>

                    <button type="submit" id="btn-login" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-slate-200 active:scale-[0.98]">
                        Sign In
                    </button>
                </form>

                <div class="mt-6 pt-6 border-t border-slate-100 text-center">
                    <p class="text-xs text-slate-400 mb-4">Don't have an account? Ask your administrator.</p>
                    <button id="btn-guest" class="text-emerald-600 hover:text-emerald-700 text-sm font-medium flex items-center justify-center gap-2 mx-auto py-2 px-4 rounded-lg hover:bg-emerald-50 transition-colors">
                        Enter as Guest (Demo) <i data-lucide="arrow-right" width="16"></i>
                    </button>
                </div>
            </div>
            <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
                <p class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold">v2.35 • Stable Release</p>
            </div>
        </div>
    </div>

    <!-- Global Header -->
   <header class="bg-white/80 backdrop-blur-lg z-40 shadow-sm border-b border-slate-200 shrink-0">
    <div class="container mx-auto px-4 py-3"> 
        <div class="flex items-center justify-between gap-2">
            <div class="font-extrabold text-lg md:text-2xl text-slate-900 truncate">
                Ground Lease Group
            </div>
            
            <div class="flex items-center gap-2"> 
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg border border-slate-200">
                    <i data-lucide="menu" size="20"></i>
                </button>
                
                <button id="logout-button" class="bg-amber-500 text-white font-bold py-2 px-3 rounded-lg hover:bg-amber-600 transition-colors text-xs md:text-sm whitespace-nowrap">
                    Logout
                </button>
            </div>
        </div>
    </div>
</header>

    <!-- App Layout -->
    <div class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
    
    <div id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out w-64 bg-slate-900 text-white flex flex-col shrink-0 z-50 shadow-xl md:shadow-none">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="building" class="text-emerald-400"></i>
                    Ground<span class="text-emerald-400">Control</span>
                </h1>
                <p class="text-xs text-slate-400 mt-2">Retail Lease Management</p>
            </div>
            <button onclick="window.toggleSidebar()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg z-50 border border-slate-200">
                <i data-lucide="menu"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('dashboard'); toggleSidebar()" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors bg-emerald-600 text-white shadow-md">
                <i data-lucide="layout-dashboard" size="20"></i>
                <span class="font-medium">Dashboard</span>
            </button>
            <button onclick="switchView('pipeline'); toggleSidebar()" id="nav-pipeline" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-800">
                <i data-lucide="map-pin" size="20"></i>
                <span class="font-medium">Deal Pipeline</span>
            </button>
            <button onclick="switchView('tasks'); toggleSidebar()" id="nav-tasks" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-800">
                <i data-lucide="calendar" size="20"></i>
                <span class="font-medium">Tasks & Dates</span>
            </button>
            <button onclick="switchView('contacts'); toggleSidebar()" id="nav-contacts" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-800">
                <i data-lucide="users" size="20"></i>
                <span class="font-medium">Contact Book</span>
            </button>
            <button onclick="switchView('calculator'); toggleSidebar()" id="nav-calculator" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors text-slate-300 hover:bg-slate-800">
                <i data-lucide="calculator" size="20"></i>
                <span class="font-medium">Rent Calculator</span>
            </button>
        </nav>
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
            v2.35.0
        </div>
    </div>

    <main class="flex-1 relative bg-slate-100 overflow-hidden">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section absolute inset-0 p-8 flex flex-col h-full overflow-y-auto">
                <div class="flex justify-between items-center mb-6 shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Dashboard</h2>
                        <p class="text-slate-500 text-sm">Welcome back. Here is your portfolio overview.</p>
                    </div>
                    <div class="text-sm text-slate-400" id="current-date-display"></div>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Total Properties</div>
                        <div class="text-2xl font-bold text-slate-800" id="dash-total-props">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-emerald-600 text-xs font-bold uppercase tracking-wider mb-1">Active Leases</div>
                        <div class="text-2xl font-bold text-emerald-700" id="dash-active-leases">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Properties Sold</div>
                        <div class="text-2xl font-bold text-slate-800" id="dash-sold-props">0</div>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div class="text-blue-600 text-xs font-bold uppercase tracking-wider mb-1">Pending Actions</div>
                        <div class="text-2xl font-bold text-blue-700" id="dash-pending-tasks">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Schedule Summary -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="text-blue-500" width="18"></i> Upcoming Schedule
                            </h3>
                            <button onclick="switchView('tasks')" class="text-xs text-blue-600 hover:underline">View All</button>
                        </div>
                        <div id="dash-upcoming-list" class="space-y-3">
                            <div class="text-slate-400 text-sm italic">Loading...</div>
                        </div>
                    </div>

                    <!-- Financial Summary & Chart -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Top Level Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <span class="block text-xs text-slate-500 uppercase">Est. Market Value (Current)</span>
                                <span class="block text-xl font-bold text-slate-800 mt-1" id="dash-est-market-value">$0</span>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <span class="block text-xs text-emerald-600 uppercase font-bold">Total Potential Profit</span>
                                <span class="block text-xl font-bold text-emerald-600 mt-1" id="dash-est-profit">$0</span>
                                <span class="text-[10px] text-slate-400">Unrealized (Current Portfolio)</span>
                            </div>
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                                <span class="block text-xs text-blue-600 uppercase font-bold">Realized Profit (Sold)</span>
                                <span class="block text-xl font-bold text-blue-600 mt-1" id="dash-realized-profit">$0</span>
                                <span class="text-[10px] text-slate-400">Closed & Sold</span>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2 mb-4">
                                <i data-lucide="bar-chart-3" class="text-indigo-500" width="18"></i> Financial Performance (Annual)
                            </h3>
                            <div class="h-64 w-full">
                                <canvas id="financialChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PIPELINE -->
            <div id="view-pipeline" class="view-section absolute inset-0 p-8 flex flex-col h-full hidden">
                <div class="flex justify-between items-center mb-6 shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Deal Pipeline</h2>
                        <p class="text-slate-500 text-sm">Track retail site acquisitions from lead to lease to sale.</p>
                    </div>
                    <button onclick="openModal('deal-modal')" class="bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-700 transition">
                        <i data-lucide="plus" size="18"></i> New Deal
                    </button>
                </div>
                
                <div class="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                    <div class="flex gap-6 min-w-max h-full" id="pipeline-container">
                        <div class="flex items-center justify-center h-full w-full text-slate-400">Loading Pipeline...</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: TASKS -->
            <div id="view-tasks" class="view-section absolute inset-0 p-8 flex flex-col h-full hidden">
                <div class="flex justify-between items-center mb-6 shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Critical Dates & Tasks</h2>
                        <p class="text-slate-500 text-sm">Manage deadlines and to-dos.</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="bg-white rounded-lg border border-slate-200 p-1 flex mr-2">
                            <button onclick="switchTaskDisplay('list')" id="btn-task-list" class="px-3 py-1.5 rounded text-sm font-medium bg-emerald-100 text-emerald-700 flex items-center gap-2 transition-colors">
                                <i data-lucide="list" width="16"></i> List
                            </button>
                            <button onclick="switchTaskDisplay('calendar')" id="btn-task-calendar" class="px-3 py-1.5 rounded text-sm font-medium text-slate-500 hover:bg-slate-50 flex items-center gap-2 transition-colors">
                                <i data-lucide="calendar" width="16"></i> Calendar
                            </button>
                        </div>
                        <button onclick="openModal('task-modal')" class="bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-700 transition">
                            <i data-lucide="plus" size="18"></i> New Task
                        </button>
                    </div>
                </div>

                <div id="task-list-container" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col h-full">
                    <div class="overflow-y-auto flex-1 p-0">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase tracking-wider sticky top-0 z-10">
                                <tr>
                                    <th class="p-4 w-12 text-center">Done</th>
                                    <th class="p-4">Task / Action</th>
                                    <th class="p-4">Related Deal</th>
                                    <th class="p-4">Due Date</th>
                                    <th class="p-4 w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <div id="task-calendar-container" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex-1 h-full overflow-hidden">
                    <div id="calendar" class="h-full"></div>
                </div>
            </div>

            <!-- VIEW: CONTACTS -->
            <div id="view-contacts" class="view-section absolute inset-0 p-8 flex flex-col h-full hidden">
                <div class="flex justify-between items-center mb-6 shrink-0 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Contacts Directory</h2>
                        <p class="text-slate-500 text-sm">Franchisees, Attorneys, and Officials.</p>
                    </div>
                    
                    <div class="flex-1 max-w-md mx-auto">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                <i data-lucide="search" width="16"></i>
                            </div>
                            <input type="text" id="contact-search" placeholder="Search contacts..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm" oninput="filterContacts(this.value)">
                        </div>
                    </div>

                    <button onclick="openModal('contact-modal')" class="bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-700 transition">
                        <i data-lucide="plus" size="18"></i> Add Contact
                    </button>
                </div>
                <div id="contacts-grid" class="overflow-y-auto pb-4 space-y-6"></div>
            </div>

            <!-- VIEW: CALCULATOR -->
            <div id="view-calculator" class="view-section absolute inset-0 p-8 flex flex-col h-full hidden overflow-y-auto">
                <div class="flex justify-between items-center mb-6 shrink-0">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Investment Financing Calculator</h2>
                        <p class="text-slate-500 text-sm">Calculate required rental rates and market valuation.</p>
                    </div>
                    <div class="flex gap-2 items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                         <span class="text-sm text-slate-600 font-medium">Load Deal:</span>
                         <select id="calc-deal-select" class="p-2 border rounded-lg text-sm min-w-[200px] outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50" onchange="loadDealToCalculator(this.value)">
                            <option value="">-- Select a Deal --</option>
                         </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                   <!-- Inputs -->
                   <div class="lg:col-span-5 space-y-6">
                      <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                         <h2 class="text-lg font-bold text-slate-800 mb-5 pb-2 border-b border-slate-100 flex items-center gap-2">
                            <i data-lucide="trending-up" class="text-blue-600" width="20"></i> Input Parameters
                         </h2>
                         
                         <div class="space-y-4">
                             <!-- Purchase Price -->
                             <div>
                                 <label class="text-sm font-semibold text-slate-700 block mb-1.5">Purchase Price (USD)</label>
                                 <div class="relative">
                                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                         <i data-lucide="dollar-sign" width="16"></i>
                                     </div>
                                     <input type="text" inputmode="decimal" id="calc-price" value="500000" data-type="currency" class="calc-input block w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900 text-sm transition-all">
                                 </div>
                             </div>

                             <div class="grid grid-cols-2 gap-4">
                                 <div>
                                     <label class="text-sm font-semibold text-slate-700 block mb-1.5">Purchase LTV %</label>
                                     <input type="text" inputmode="decimal" id="calc-ltv" value="100" data-type="percent" class="calc-input block w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                 </div>
                                 <div>
                                     <label class="text-sm font-semibold text-slate-700 block mb-1.5">Interest Rate %</label>
                                     <input type="text" inputmode="decimal" id="calc-rate" value="6.0" data-type="percent" class="calc-input block w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                 </div>
                             </div>

                             <div class="grid grid-cols-2 gap-4">
                                 <div>
                                     <label class="text-sm font-semibold text-slate-700 block mb-1.5">Amortization (Mo)</label>
                                     <input type="text" inputmode="decimal" id="calc-term" value="300" class="calc-input block w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm transition-all disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed">
                                     <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                        <input type="checkbox" id="calc-interest-only" class="calc-input rounded border-slate-300 text-blue-600 focus:ring-blue-500 w-3 h-3">
                                        <span class="text-xs text-slate-500 font-medium">Interest Only</span>
                                     </label>
                                 </div>
                                 <div>
                                     <label class="text-sm font-semibold text-slate-700 block mb-1.5">DSCR Target</label>
                                     <input type="text" inputmode="decimal" id="calc-dscr" value="1.20" class="calc-input block w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                 </div>
                             </div>

                             <!-- Holding Costs Section -->
                             <div class="pt-4 border-t border-slate-100">
                                <h3 class="text-sm font-bold text-slate-800 mb-3">Holding Costs (Year 1) & Capex</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-semibold text-slate-500 block mb-1.5">RE Taxes ($)</label>
                                        <input type="text" inputmode="decimal" id="calc-taxes" value="0" data-type="currency" class="calc-input block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-slate-500 block mb-1.5">Insurance ($)</label>
                                        <input type="text" inputmode="decimal" id="calc-insurance" value="0" data-type="currency" class="calc-input block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                    </div>
                                </div>
                                <div class="mt-3">
                                     <label class="text-xs font-semibold text-slate-500 block mb-1.5">Landlord's Work ($)</label>
                                     <input type="text" inputmode="decimal" id="calc-landlord-work" value="0" data-type="currency" class="calc-input block w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                </div>
                                <div class="mt-3 flex justify-between items-center text-xs bg-amber-50 p-2 rounded border border-amber-100">
                                    <span class="text-amber-800 font-medium">Total Holding (Inc. Debt):</span>
                                    <span class="font-bold text-amber-900" id="res-holding-total">$0</span>
                                </div>
                             </div>

                             <!-- Contract Rent Override Section -->
                             <div class="pt-4 border-t border-slate-100">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-semibold text-slate-700">Contract Rent (Override)</label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="calc-use-contract" class="calc-input rounded border-slate-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                                        <span class="text-xs text-slate-500">Use Contract Rent?</span>
                                    </label>
                                </div>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                                        <i data-lucide="dollar-sign" width="16"></i>
                                    </div>
                                    <input type="text" inputmode="decimal" id="calc-contract-rent" value="0" data-type="currency" class="calc-input block w-full pl-10 pr-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-slate-900 text-sm transition-all disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed" disabled>
                                </div>
                             </div>

                             <div class="grid grid-cols-2 gap-4">
                                 <div>
                                     <label class="text-sm font-semibold text-slate-700 block mb-1.5">Market Cap Rate %</label>
                                     <input type="text" inputmode="decimal" id="calc-cap" value="6.0" data-type="percent" class="calc-input block w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                 </div>
                                 <div>
                                     <label class="text-sm font-semibold text-slate-700 block mb-1.5">Market LTV Limit %</label>
                                     <input type="text" inputmode="decimal" id="calc-market-ltv" value="70" data-type="percent" class="calc-input block w-full px-4 py-2.5 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-slate-900 text-sm">
                                 </div>
                             </div>

                             <div class="mt-6 bg-blue-50 rounded-lg p-4 border border-blue-100">
                                <div class="text-sm text-blue-800 font-medium mb-1">Loan Summary</div>
                                <div class="flex justify-between items-center">
                                  <span class="text-blue-600 text-sm">Principal Amount</span>
                                  <span class="text-blue-900 font-bold" id="res-loan-amount">$0</span>
                                </div>
                              </div>
                         </div>
                      </div>
                   </div>

                   <!-- Results -->
                   <div class="lg:col-span-7 space-y-6">
                      <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 h-full flex flex-col">
                         <h2 class="text-lg font-bold text-slate-800 mb-5 pb-2 border-b border-slate-100 flex items-center gap-2">
                            <i data-lucide="dollar-sign" class="text-emerald-600" width="20"></i> Financial Analysis
                         </h2>

                         <div class="space-y-1 flex-grow">
                            <!-- Rows -->
                            <div class="flex justify-between items-start py-3 border-b border-slate-100">
                                <span class="text-sm text-slate-600 font-medium pt-0.5">Annual Debt Service</span>
                                <div class="text-right">
                                    <div class="text-base font-bold text-slate-900" id="res-annual-debt">$0</div>
                                    <div class="text-xs text-slate-500 mt-0.5" id="res-monthly-debt">$0 / month</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-start py-3 border-b border-slate-100 bg-slate-50 -mx-4 px-4">
                                <span class="text-sm text-slate-600 font-medium pt-0.5">Required Net Rental Rate</span>
                                <div class="text-right">
                                    <div class="text-base font-bold text-slate-900" id="res-rental-rate">$0</div>
                                    <div class="text-xs text-slate-500 mt-0.5" id="res-dscr-label">Inc. Debt(DSCR) + Tax/Ins + 10% Work</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-start py-3 border-b border-slate-100">
                                <span class="text-sm text-slate-600 font-medium pt-0.5">Projected Market Value</span>
                                <div class="text-right">
                                    <div class="text-base font-bold text-slate-900" id="res-market-value">$0</div>
                                    <div class="text-xs text-slate-500 mt-0.5" id="res-cap-label">@ 6.0% Cap Rate</div>
                                </div>
                            </div>

                            <div class="flex justify-between items-start py-3 border-b border-slate-100">
                                <span class="text-sm text-slate-600 font-medium pt-0.5">Implied LTV (Price / Market Value)</span>
                                <div class="text-right">
                                    <div class="text-base font-bold" id="res-implied-ltv">0%</div>
                                    <div class="text-xs text-slate-500 mt-0.5" id="res-ltv-subtext">Target: < 70%</div>
                                </div>
                            </div>

                            <div class="my-6 pt-6 border-t border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-lg font-bold text-slate-900">100% Financing Viable?</h3>
                                        <p class="text-sm text-slate-500 mt-1">Is Implied LTV &lt; Market LTV?</p>
                                    </div>
                                    <div id="res-finance-badge" class="flex items-center gap-2 px-5 py-2.5 rounded-full font-bold text-lg border bg-slate-100 text-slate-500 border-slate-200">
                                        Checking...
                                    </div>
                                </div>
                                <div class="mt-4 p-4 bg-slate-50 rounded-lg text-sm text-slate-600">
                                    <div class="flex justify-between mb-1">
                                        <span>Lender Max Loan Amount:</span>
                                        <span class="font-semibold" id="res-max-loan">$0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Purchase Price:</span>
                                        <span class="font-semibold" id="res-price-check">$0</span>
                                    </div>
                                    <div class="mt-2 text-xs text-slate-400 border-t border-slate-200 pt-2" id="res-explanation">
                                        Analysis text will appear here.
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h3 class="text-sm font-semibold text-slate-900 mb-3 uppercase tracking-wider">Investor Return</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-100">
                                        <div class="text-sm text-emerald-800 font-medium mb-1">Potential Profit</div>
                                        <div class="text-2xl font-bold text-emerald-700" id="res-profit">$0</div>
                                        <div class="text-xs text-emerald-600 mt-1" id="res-profit-subtext">After Holding & Work</div>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <div class="text-sm text-blue-800 font-medium mb-1">ROI (On Total Cost)</div>
                                        <div class="text-2xl font-bold text-blue-700" id="res-roi">0%</div>
                                        <div class="text-xs text-blue-600 mt-1" id="res-roi-subtext">Basis: Price + Holding + Work</div>
                                    </div>
                                </div>
                            </div>

                         </div>
                      </div>
                   </div>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->
    
    <!-- Deal Modal (New/Edit) -->
    <div id="deal-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800" id="deal-modal-title">Add New Deal</h3>
                <button onclick="closeModal('deal-modal')" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
            </div>
            <form id="deal-form" class="p-6 space-y-4">
                <input type="hidden" id="deal-id">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Deal Name / Tenant</label>
                    <input type="text" id="deal-name" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="e.g. Starbucks - Greenwood" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Property Address</label>
                    <input type="text" id="deal-address" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="123 Main St" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Est. Value / Purchase ($)</label>
                        <input type="text" inputmode="decimal" id="deal-value" data-type="currency" class="calc-input w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="1,200,000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Stage</label>
                        <select id="deal-stage" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <option value="prospect">Prospecting</option>
                            <option value="loi">LOI / Offer</option>
                            <option value="dd">Due Diligence</option>
                            <option value="closing">Closing</option>
                            <option value="leased">Active Lease</option>
                            <option value="sold">Properties Sold</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Sale Price ($) <span class="text-xs text-slate-400 font-normal">(If Sold)</span></label>
                        <input type="text" inputmode="decimal" id="deal-sale-price" data-type="currency" class="calc-input w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="0">
                    </div>
                    <div></div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-t pt-4 border-slate-100">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Lease Start (Optional)</label>
                        <input type="date" id="deal-commencement-date" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-slate-600 text-sm">
                        <span class="text-[10px] text-slate-400">For Active Deals</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Sale Date (Optional)</label>
                        <input type="date" id="deal-sale-date" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-slate-600 text-sm">
                        <span class="text-[10px] text-slate-400">For Sold Properties</span>
                    </div>
                </div>

                <button type="submit" id="deal-submit-btn" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 mt-4 transition-colors">Create Deal</button>
            </form>
        </div>
    </div>

    <!-- Deal Detail Modal -->
    <div id="deal-detail-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[85vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b bg-slate-50 shrink-0">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800" id="detail-deal-name">Deal Name</h3>
                    <p class="text-slate-500 text-sm flex items-center gap-2 mt-1">
                        <i data-lucide="map-pin" width="14"></i> <span id="detail-deal-address">Address</span>
                    </p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="editCurrentDeal()" class="text-slate-500 hover:text-emerald-600 font-medium text-sm flex items-center gap-1">
                        <i data-lucide="edit-2" width="14"></i> Edit Deal
                    </button>
                    <button onclick="closeModal('deal-detail-modal')" class="text-slate-400 hover:text-red-500 ml-4">
                        <i data-lucide="x" width="24"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 bg-slate-50/50">
                
                <!-- Rent Calculator Summary -->
                <div id="deal-calc-summary" class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm mb-6 hidden">
                    <h4 class="font-bold text-slate-700 flex items-center gap-2 mb-3">
                        <i data-lucide="trending-up" class="text-blue-600" width="18"></i> Financial Snapshot
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                        <div>
                            <span class="block text-slate-500 text-xs" id="summary-rent-label">Required Rent (NOI)</span>
                            <span class="block font-bold text-slate-800 text-lg" id="summary-rent">$0</span>
                        </div>
                        <div>
                            <span class="block text-slate-500 text-xs">Projected Value</span>
                            <span class="block font-bold text-slate-800 text-lg" id="summary-value">$0</span>
                        </div>
                        <div>
                            <span class="block text-slate-500 text-xs">Potential Profit</span>
                            <span class="block font-bold text-emerald-600 text-lg" id="summary-profit">$0</span>
                        </div>
                        <div>
                            <span class="block text-slate-500 text-xs">ROI (On Price)</span>
                            <span class="block font-bold text-blue-600 text-lg" id="summary-roi">0%</span>
                        </div>
                        <div>
                            <span class="block text-slate-500 text-xs">100% Finance?</span>
                            <span class="block font-bold text-slate-800 text-lg" id="summary-finance">--</span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-slate-400 border-t border-slate-100 pt-2 flex justify-between">
                        <span id="summary-assumptions-text">Based on standard assumptions</span>
                        <a href="#" onclick="closeModal('deal-detail-modal'); switchView('calculator'); loadDealToCalculator(currentDealId);" class="text-blue-600 hover:underline">Open in Calculator</a>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="calendar" class="text-emerald-600" width="18"></i> Related Tasks
                            </h4>
                            <button onclick="openModal('task-modal', currentDealId)" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-emerald-50 text-slate-600 font-medium">+ Add Task</button>
                        </div>
                        <div id="detail-tasks-list" class="space-y-2"></div>
                    </div>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 flex items-center gap-2">
                                <i data-lucide="users" class="text-emerald-600" width="18"></i> Related Contacts
                            </h4>
                            <button onclick="openModal('contact-modal', currentDealId)" class="text-xs bg-white border border-slate-200 px-2 py-1 rounded hover:bg-emerald-50 text-slate-600 font-medium">+ Add Contact</button>
                        </div>
                        <div id="detail-contacts-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t bg-white flex justify-between items-center text-sm text-slate-500">
                <span id="detail-deal-value" class="font-mono font-medium text-emerald-600"></span>
                <span id="detail-deal-stage" class="px-2 py-1 rounded bg-slate-100 text-slate-600 text-xs font-bold uppercase"></span>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800" id="task-modal-title">New Task</h3>
                <button onclick="closeModal('task-modal')" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
            </div>
            <form id="task-form" class="p-6 space-y-4">
                <input type="hidden" id="task-id">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Task / Action</label>
                    <input type="text" id="task-title" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="e.g. Sign Purchase Agreement" required>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Due Date</label>
                        <input type="date" id="task-date" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Time</label>
                        <input type="time" id="task-time" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Related Deal</label>
                    <select id="task-deal-id" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                        <option value="">-- General Task --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                    <textarea id="task-notes" rows="3" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"></textarea>
                </div>
                <button type="submit" id="task-submit-btn" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 mt-4 transition-colors">Save Task</button>
            </form>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contact-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b bg-slate-50">
                <h3 class="text-lg font-bold text-slate-800" id="contact-modal-title">Add Contact</h3>
                <button onclick="closeModal('contact-modal')" class="text-slate-400 hover:text-red-500"><i data-lucide="x"></i></button>
            </div>
            <form id="contact-form" class="p-6 space-y-4">
                <input type="hidden" id="contact-id">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                    <input type="text" id="contact-name" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                        <select id="contact-category" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <option value="Seller">Seller</option>
                            <option value="Franchisor">Franchisor</option>
                            <option value="Franchisee">Franchisee</option>
                            <option value="Lender">Lender</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                         <label class="block text-sm font-medium text-slate-700 mb-1">Role/Title</label>
                        <input type="text" id="contact-role" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="e.g. Zoning Attorney">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Company</label>
                    <input type="text" id="contact-company" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="e.g. Acme Corp">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input type="email" id="contact-email" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Phone</label>
                        <input type="tel" id="contact-phone" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Associated Deals</label>
                    <div id="contact-deal-container" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white h-32 overflow-y-auto space-y-1"></div>
                </div>
                <button type="submit" id="contact-submit-btn" class="w-full bg-emerald-600 text-white py-2 rounded-lg font-medium hover:bg-emerald-700 mt-4 transition-colors">Save Contact</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Safe Sidebar Toggle (Mobile)
        window.toggleSidebar = function() {
            if (window.innerWidth >= 768) return;
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
            } else {
                sidebar.classList.add('-translate-x-full');
            }
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- HARDCODED CREDENTIALS (SAFE ONLY WITH HTTP REFERRER RESTRICTIONS) ---
        // 1. Go to Google Cloud Console > Credentials.
        // 2. Edit API Key > Application restrictions > HTTP referrers (websites).
        // 3. Add: https://landhavenradh.github.io/* and http://localhost:*
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            // Preview Environment
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            // Local / Production Environment
            firebaseConfig = {
                // PASTE YOUR NEW API KEYS HERE
                apiKey: "AIzaSyAFvNkM8_MZ1n13EbAG3QzvTj50zZDcpqE",
                authDomain: "restaurant-groundworks-db.firebaseapp.com",
                projectId: "restaurant-groundworks-db",
                storageBucket: "restaurant-groundworks-db.firebasestorage.app",
                messagingSenderId: "391704584139",
                appId: "1:391704584139:web:bee1a86cde8411acf8a04e",
                measurementId: "G-J6FR64HDJP"
            };
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase
        let app, auth, db;
        try {
            if (!firebaseConfig.apiKey) {
                console.warn("Firebase Config missing. Waiting for keys.");
            } else {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) {
            console.error("Firebase Init Error", e);
        }

        // --- State ---
        let deals = [];
        let tasks = [];
        let contacts = [];
        let currentUserId = null;
        let calendar = null;
        let financialChart = null; 
        let currentDealId = null; 
        let currentlyLoadedDealForCalc = null;

        // --- Logic Functions (Hoisted) ---
        function formatTimeForDisplay(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            const formattedMinutes = minutes.length < 2 ? `0${minutes}` : minutes;
            return `${h12}:${formattedMinutes} ${ampm}`;
        }

        function formatDateForDisplay(dateString) {
            if (!dateString) return 'No Date';
            const [year, month, day] = dateString.split('-').map(Number);
            const date = new Date(year, month - 1, day); 
            return date.toLocaleDateString();
        }

        function getRawValue(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const val = el.value.replace(/[^0-9.-]/g, '');
            return parseFloat(val) || 0;
        }

        function formatField(el, type) {
            const val = el.value.replace(/[^0-9.-]/g, '');
            if (val === '') return;
            const num = parseFloat(val);
            if (isNaN(num)) return;
            if (type === 'currency') el.value = num.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
            else if (type === 'percent') el.value = num.toLocaleString('en-US', { maximumFractionDigits: 3 }) + '%';
        }
        
        function updateCalendarEvents() {
            if (calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource(tasks.map(t => ({ id: t.id, title: t.title + (t.time ? ` @ ${formatTimeForDisplay(t.time)}` : ''), start: t.time ? `${t.date}T${t.time}` : t.date, backgroundColor: t.completed ? '#94a3b8' : '#3b82f6', borderColor: t.completed ? '#94a3b8' : '#3b82f6', textColor: '#ffffff' })));
            }
        }
        
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if(!calendarEl) return;
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                height: '100%', editable: true,
                events: tasks.map(t => ({ id: t.id, title: t.title + (t.time ? ` @ ${formatTimeForDisplay(t.time)}` : ''), start: t.time ? `${t.date}T${t.time}` : t.date, backgroundColor: t.completed ? '#94a3b8' : '#3b82f6', borderColor: t.completed ? '#94a3b8' : '#3b82f6', textColor: '#ffffff' })),
                eventClick: function(info) { window.editTask(info.event.id); },
                eventDrop: async function(info) {
                    const newDate = info.event.start.toISOString().split('T')[0];
                    try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gc_tasks', info.event.id), { date: newDate }); }
                    catch (error) { info.revert(); }
                }
            });
            calendar.render();
        }

        // --- Render Functions (Hoisted) ---
        const STAGES = [
            { id: 'prospect', label: 'Prospecting', color: 'border-blue-500' },
            { id: 'loi', label: 'LOI / Offer', color: 'border-yellow-500' },
            { id: 'dd', label: 'Due Diligence', color: 'border-orange-500' },
            { id: 'closing', label: 'Closing', color: 'border-purple-500' },
            { id: 'leased', label: 'Active Lease', color: 'border-emerald-500' },
            { id: 'sold', label: 'Properties Sold', color: 'border-slate-500' }
        ];

        function renderPipeline() {
            const container = document.getElementById('pipeline-container');
            if(!container) return;
            container.innerHTML = '';
            STAGES.forEach(stage => {
                const stageDeals = deals.filter(d => d.stage === stage.id);
                const col = document.createElement('div');
                col.className = 'w-80 flex flex-col h-full';
                col.innerHTML = `
                    <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 ${stage.color} font-semibold text-slate-700">
                        <span class="flex-1">${stage.label}</span>
                        <span class="bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold">${stageDeals.length}</span>
                    </div>
                    <div class="flex-1 bg-slate-200/50 rounded-lg p-2 space-y-3 overflow-y-auto no-scrollbar">
                        ${stageDeals.map(deal => {
                            let formattedValue = '$0';
                            try {
                                const valStr = deal.value ? deal.value.toString().replace(/[^0-9.-]+/g, "") : "0";
                                const valNum = parseFloat(valStr) || 0;
                                formattedValue = valNum.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
                            } catch (e) { formattedValue = 'Error'; }
                            
                            return `
                            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition group relative drag-card cursor-pointer" onclick="window.openDealDetail('${deal.id}')">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-slate-800">${deal.name}</h4>
                                    <button onclick="event.stopPropagation(); window.deleteDeal('${deal.id}')" class="text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" width="14"></i></button>
                                </div>
                                <p class="text-xs text-slate-500 flex items-center gap-1 mb-3">
                                    <i data-lucide="map-pin" width="12"></i> ${deal.address || 'No Address'}
                                </p>
                                <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-100">
                                    <span class="text-xs font-mono font-medium text-emerald-600">${formattedValue}</span>
                                    <select onclick="event.stopPropagation()" onchange="window.moveStage('${deal.id}', this.value)" class="text-xs bg-slate-100 border-none rounded px-2 py-1 cursor-pointer hover:bg-slate-200 focus:ring-0">
                                        ${STAGES.map(s => `<option value="${s.id}" ${s.id === deal.stage ? 'selected' : ''}>${s.label}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        `}).join('')}
                    </div>`;
                container.appendChild(col);
            });
            if (window.lucide) lucide.createIcons();
        }
        
        function renderTasks() {
            const tbody = document.getElementById('tasks-table-body');
            if(!tbody) return;
            const sortedTasks = [...tasks].sort((a,b) => (a.completed === b.completed ? new Date(a.date) - new Date(b.date) : a.completed ? 1 : -1));
            if(sortedTasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-slate-400">No active tasks</td></tr>';
                return;
            }
            const today = new Date(); today.setHours(0,0,0,0);
            tbody.innerHTML = sortedTasks.map(task => {
                const dealName = deals.find(d => d.id === task.dealId)?.name || 'General';
                const [y, m, d] = task.date.split('-').map(Number);
                const taskDate = new Date(y, m - 1, d);
                const isOverdue = !task.completed && taskDate < today;
                return `
                    <tr class="group hover:bg-slate-50 transition cursor-pointer ${task.completed ? 'bg-slate-50/50' : ''}" onclick="window.editTask('${task.id}')">
                        <td class="p-4 text-center">
                            <button onclick="event.stopPropagation(); window.toggleTask('${task.id}', ${!task.completed})" class="w-6 h-6 rounded border flex items-center justify-center transition-colors ${task.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-300 hover:border-emerald-500'}">
                                ${task.completed ? '<i data-lucide="check" width="14"></i>' : ''}
                            </button>
                        </td>
                        <td class="p-4">
                            <p class="font-medium text-slate-800 ${task.completed ? 'line-through text-slate-400' : ''}">${task.title}</p>
                            <p class="text-xs text-slate-500 mt-1">${task.notes || 'No notes'}</p>
                        </td>
                        <td class="p-4"><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">${dealName}</span></td>
                        <td class="p-4">
                            <div class="flex items-center gap-2 text-sm ${isOverdue ? 'text-red-600 font-bold' : 'text-slate-600'}">
                                ${formatDateForDisplay(task.date)}
                                ${task.time ? `<span class="text-xs text-slate-400 ml-1">@ ${formatTimeForDisplay(task.time)}</span>` : ''}
                                ${isOverdue ? '<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded uppercase">Overdue</span>' : ''}
                            </div>
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="event.stopPropagation(); window.deleteTask('${task.id}')" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="trash-2" width="16"></i></button>
                        </td>
                    </tr>`;
            }).join('');
            if (window.lucide) lucide.createIcons();
        }

        function renderContacts() {
            const grid = document.getElementById('contacts-grid');
            if(!grid) return;
            if(contacts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">No contacts added yet.</div>';
                return;
            }
            const searchVal = document.getElementById('contact-search')?.value.toLowerCase() || '';
            const filteredContacts = contacts.filter(c => 
                (c.name && c.name.toLowerCase().includes(searchVal)) ||
                (c.email && c.email.toLowerCase().includes(searchVal)) ||
                (c.role && c.role.toLowerCase().includes(searchVal))
            );
            const groups = { 'Seller': [], 'Franchisor': [], 'Franchisee': [], 'Lender': [], 'Other': [] };
            filteredContacts.forEach(c => {
                const category = c.category || 'Other';
                if (groups[category]) groups[category].push(c); else groups['Other'].push(c);
            });

            let html = '';
            for (const [category, groupContacts] of Object.entries(groups)) {
                if (groupContacts.length > 0) {
                    html += `
                        <div>
                            <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3 px-1">${category} (${groupContacts.length})</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                ${groupContacts.map(c => {
                                    const initial = (c.name && c.name.length > 0) ? c.name.charAt(0).toUpperCase() : '?';
                                    let dealDisplay = 'General Contact';
                                    const linkedDealIds = c.dealIds || (c.dealId ? [c.dealId] : []);
                                    if (linkedDealIds.length > 0) {
                                        const firstDeal = deals.find(d => d.id === linkedDealIds[0]);
                                        if (firstDeal) dealDisplay = linkedDealIds.length > 1 ? `${firstDeal.name} + ${linkedDealIds.length - 1} more` : firstDeal.name;
                                    }
                                    return `
                                    <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition relative group cursor-pointer" onclick="window.editContact('${c.id}')">
                                        <button onclick="event.stopPropagation(); window.deleteContact('${c.id}')" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="x" width="16"></i></button>
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-700 flex items-center justify-center font-bold text-lg">${initial}</div>
                                            <div>
                                                <h4 class="font-bold text-slate-800">${c.name || 'No Name'}</h4>
                                                <p class="text-xs text-slate-500 uppercase tracking-wider font-semibold">${c.role || 'No Role'}</p>
                                            </div>
                                        </div>
                                        <div class="space-y-2 mt-4 text-sm text-slate-600">
                                            <div class="flex items-center gap-2"><i data-lucide="mail" width="14" class="text-slate-400"></i> <span class="truncate hover:text-emerald-600">${c.email || 'No Email'}</span></div>
                                            <div class="flex items-center gap-2"><i data-lucide="phone" width="14" class="text-slate-400"></i> <span>${c.phone || 'No Phone'}</span></div>
                                            <div class="flex items-center gap-2"><i data-lucide="briefcase" width="14" class="text-slate-400"></i> <span class="bg-slate-100 px-2 py-0.5 rounded text-xs">${dealDisplay}</span></div>
                                            ${c.company ? `<div class="flex items-center gap-2"><i data-lucide="building" width="14" class="text-slate-400"></i> <span class="bg-slate-100 px-2 py-0.5 rounded text-xs">${c.company}</span></div>` : ''}
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>`;
                }
            }
            if (filteredContacts.length === 0) html = '<div class="col-span-full text-center py-12 text-slate-400">No contacts found.</div>';
            grid.innerHTML = html;
            if (window.lucide) lucide.createIcons();
        }

        // --- Diagnostics Functions ---
        function logDiagnostic(message, type = 'info') {
            const container = document.getElementById('log-container');
            const initMsg = document.getElementById('init-msg');
            if(initMsg) initMsg.style.display = 'none';

            if (!container) return;
            
            const div = document.createElement('div');
            div.className = type === 'error' ? 'text-red-400 font-bold' : (type === 'success' ? 'text-emerald-400' : 'text-slate-400');
            div.innerHTML = `<span class="opacity-50">[${new Date().toLocaleTimeString().split(' ')[0]}]</span> ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Authentication Flow ---
        const loginOverlay = document.getElementById('login-overlay');
        const loginError = document.getElementById('login-error');
        const loginErrorText = document.getElementById('login-error-text');

        function setupAuthListeners() {
            if (!auth) {
                logDiagnostic("Auth not initialized. Check config.", "error");
                return;
            }

            // 1. Initial Token Check
            const initAuth = async () => {
                logDiagnostic("Checking auth state...");
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } 
            };
            initAuth();

            // 2. Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    logDiagnostic(`✅ Authenticated: ${user.email || 'Anonymous'}`, "success");
                    currentUserId = user.uid;
                    
                    // FORCE HIDE
                    const overlay = document.getElementById('login-overlay');
                    if(overlay) {
                        overlay.classList.add('hidden-overlay');
                        setTimeout(() => overlay.style.display = 'none', 500); // Remove from flow after transition
                    }
                    
                    initApp(user);
                } else {
                    logDiagnostic("User signed out.");
                    currentUserId = null;
                    loginOverlay.classList.remove('hidden-overlay');
                }
            });

            // 3. Login Form Handler
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btn-login');
                const originalText = btn.innerText;
                btn.innerText = 'Signing In...';
                btn.disabled = true;
                loginError.classList.add('hidden');

                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    logDiagnostic("Attempting login...");
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login Failed:", error);
                    let msg = "Login failed.";
                    if (error.code === 'auth/invalid-email') msg = "Invalid email address format.";
                    else if (error.code === 'auth/user-not-found') msg = "No user found with this email.";
                    else if (error.code === 'auth/wrong-password') msg = "Incorrect password.";
                    else if (error.code === 'auth/too-many-requests') msg = "Too many attempts. Try again later.";
                    else if (error.message && error.message.includes('requests-from-referer')) msg = "Domain Not Authorized. Go to Google Cloud Console > APIs & Services > Credentials > API Key > Website restrictions and add: https://landhavenradh.github.io/*";
                    else if (error.message) msg = error.message;

                    logDiagnostic(`Login Error: ${msg}`, "error");
                    loginErrorText.textContent = msg;
                    loginError.classList.remove('hidden');
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            });

            // 4. Guest Login Handler
            document.getElementById('btn-guest').addEventListener('click', async () => {
                const btn = document.getElementById('btn-guest');
                btn.innerHTML = 'Accessing Demo...';
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Guest login error:", error);
                    alert("Demo access failed. Check console.");
                    btn.innerHTML = 'Enter as Guest (Demo) <i data-lucide="arrow-right" width="16"></i>';
                }
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                signOut(auth).then(() => window.location.reload());
            });
        }

        // --- Secure Collection Path Helper ---
        const getCollectionRef = (colName) => {
             // HYBRID PATH STRATEGY:
             if (typeof __app_id !== 'undefined') {
                 // PREVIEW: Use sandbox
                 return collection(db, 'artifacts', __app_id, 'public', 'data', colName);
             } else {
                 // PROD: Use root
                 return collection(db, colName);
             }
        };

        // --- Initialization ---
        function initApp(user) {
            try {
                if (window.lucide) lucide.createIcons();
                setupFormattedInputs(); 
                
                const dateEl = document.getElementById('current-date-display');
                if(dateEl) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dateEl.textContent = new Date().toLocaleDateString('en-US', options);
                }

                // Use Secure Paths
                logDiagnostic("📡 Connecting to 'gc_deals'...");
                
                // DEALS
                onSnapshot(getCollectionRef("gc_deals"), (snapshot) => {
                    deals = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    logDiagnostic(`📥 Loaded ${deals.length} deals.`);
                    
                    try { renderPipeline(); } catch(e) { logDiagnostic(`⚠️ Pipeline Render Failed: ${e.message}`, "error"); console.error(e); }
                    try { populateDealSelects(); } catch(e) { logDiagnostic(`⚠️ Selects Failed: ${e.message}`, "error"); }
                    
                    // Force render dashboard regardless of visibility on first load to update counts
                    try { renderDashboard(); } catch(e) { logDiagnostic(`⚠️ Dashboard Render Failed: ${e.message}`, "error"); console.error(e); }
                    
                    if (currentDealId && !document.getElementById('deal-detail-modal').classList.contains('hidden')) window.openDealDetail(currentDealId);
                }, (error) => {
                    console.error("Deal Sync Error:", error);
                    logDiagnostic(`❌ Deals Error: ${error.code}`, "error");
                    if (error.code === 'permission-denied') alert("Database Permission Denied. Check your Firestore Security Rules.");
                });

                // TASKS
                logDiagnostic("📡 Connecting to 'gc_tasks'...");
                onSnapshot(getCollectionRef("gc_tasks"), (snapshot) => {
                    tasks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    logDiagnostic(`📥 Loaded ${tasks.length} tasks.`);
                    
                    try { renderTasks(); } catch(e) { logDiagnostic(`⚠️ Tasks Render Failed: ${e.message}`, "error"); }
                    try { updateCalendarEvents(); } catch(e) { logDiagnostic(`⚠️ Calendar Failed: ${e.message}`, "error"); }
                    
                    try { renderDashboard(); } catch(e) {} // Silent update
                    
                    if (currentDealId && !document.getElementById('deal-detail-modal').classList.contains('hidden')) renderRelatedTasks(currentDealId);
                }, (error) => {
                    console.error("Tasks Sync Error:", error);
                    logDiagnostic(`❌ Tasks Error: ${error.code}`, "error");
                });

                // CONTACTS
                logDiagnostic("📡 Connecting to 'gc_contacts'...");
                onSnapshot(getCollectionRef("gc_contacts"), (snapshot) => {
                    contacts = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    logDiagnostic(`📥 Loaded ${contacts.length} contacts.`);
                    
                    try { renderContacts(); } catch(e) { logDiagnostic(`⚠️ Contacts Render Failed: ${e.message}`, "error"); }
                    
                    if (currentDealId && !document.getElementById('deal-detail-modal').classList.contains('hidden')) renderRelatedContacts(currentDealId);
                }, (error) => {
                    console.error("Contacts Sync Error:", error);
                    logDiagnostic(`❌ Contacts Error: ${error.code}`, "error");
                });
                
            } catch (e) {
                console.error("Init Error:", e);
                logDiagnostic(`Init Exception: ${e.message}`, "error");
            }
        }

        // --- View Switching ---
        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white', 'shadow-md');
                el.classList.add('text-slate-300', 'hover:bg-slate-800');
            });
            const activeBtn = document.getElementById(`nav-${viewName}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-800');
            activeBtn.classList.add('bg-emerald-600', 'text-white', 'shadow-md');

            if (viewName === 'tasks' && calendar) setTimeout(() => calendar.render(), 100);
            // Re-render to ensure data is fresh
            if (viewName === 'dashboard') try { renderDashboard(); } catch(e) {}
            if (viewName === 'pipeline') try { renderPipeline(); } catch(e) {}
        };

        window.switchTaskDisplay = (mode) => {
            const listContainer = document.getElementById('task-list-container');
            const calendarContainer = document.getElementById('task-calendar-container');
            const btnList = document.getElementById('btn-task-list');
            const btnCalendar = document.getElementById('btn-task-calendar');

            if (mode === 'list') {
                listContainer.classList.remove('hidden');
                calendarContainer.classList.add('hidden');
                btnList.classList.add('bg-emerald-100', 'text-emerald-700');
                btnList.classList.remove('text-slate-500', 'hover:bg-slate-50');
                btnCalendar.classList.add('text-slate-500', 'hover:bg-slate-50');
                btnCalendar.classList.remove('bg-emerald-100', 'text-emerald-700');
            } else {
                listContainer.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                btnCalendar.classList.add('bg-emerald-100', 'text-emerald-700');
                btnCalendar.classList.remove('text-slate-500', 'hover:bg-slate-50');
                btnList.classList.add('text-slate-500', 'hover:bg-slate-50');
                btnList.classList.remove('bg-emerald-100', 'text-emerald-700');
                if (!calendar) initCalendar();
                else calendar.render();
            }
        };

        // --- Modal Logic ---
        window.openModal = (id, dealId = null) => {
            if (id === 'deal-modal') {
                document.getElementById('deal-form').reset();
                document.getElementById('deal-id').value = ''; 
                document.getElementById('deal-modal-title').textContent = 'Add New Deal';
                document.getElementById('deal-submit-btn').textContent = 'Create Deal';
            } else if (id === 'task-modal') {
                document.getElementById('task-form').reset();
                document.getElementById('task-id').value = ''; 
                document.getElementById('task-modal-title').textContent = 'New Task';
                document.getElementById('task-submit-btn').textContent = 'Save Task';
                populateDealSelects();
                if(dealId) document.getElementById('task-deal-id').value = dealId;
            } else if (id === 'contact-modal') {
                document.getElementById('contact-form').reset();
                document.getElementById('contact-id').value = ''; 
                document.getElementById('contact-modal-title').textContent = 'Add Contact';
                document.getElementById('contact-submit-btn').textContent = 'Save Contact';
                populateDealSelects();
                if(dealId) {
                    const checkbox = document.getElementById(`contact-deal-${dealId}`);
                    if (checkbox) checkbox.checked = true;
                }
            }
            document.getElementById(id).classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- Core App Logic (Same as before, just path secure) ---
        
        window.openDealDetail = (id) => {
            currentDealId = id;
            const deal = deals.find(d => d.id === id);
            if (!deal) return;
            document.getElementById('detail-deal-name').textContent = deal.name;
            document.getElementById('detail-deal-address').textContent = deal.address;
            document.getElementById('detail-deal-value').textContent = deal.value ? `$${deal.value}` : '$0';
            const stageLabel = STAGES.find(s => s.id === deal.stage)?.label || deal.stage;
            document.getElementById('detail-deal-stage').textContent = stageLabel;
            renderRelatedTasks(id);
            renderRelatedContacts(id);
            renderDealSummary(deal);
            document.getElementById('deal-detail-modal').classList.remove('hidden');
        }

        window.editCurrentDeal = () => {
            window.closeModal('deal-detail-modal');
            window.editDeal(currentDealId);
        }

        function renderRelatedTasks(dealId) {
            const container = document.getElementById('detail-tasks-list');
            const relatedTasks = tasks.filter(t => t.dealId === dealId);
            if (relatedTasks.length === 0) {
                container.innerHTML = '<div class="text-slate-400 text-sm italic py-2">No tasks linked to this deal.</div>';
                return;
            }
            container.innerHTML = relatedTasks.map(t => {
                const timeString = t.time ? `<span class="text-xs text-slate-400 ml-1">@ ${formatTimeForDisplay(t.time)}</span>` : '';
                return `
                <div class="bg-white p-3 rounded border border-slate-200 hover:shadow-sm transition flex justify-between items-center cursor-pointer" onclick="window.editTask('${t.id}')">
                    <div>
                        <div class="font-medium text-sm text-slate-800 ${t.completed ? 'line-through text-slate-400' : ''}">${t.title}</div>
                        <div class="text-xs text-slate-500">${formatDateForDisplay(t.date)}${timeString}</div>
                    </div>
                    <button onclick="event.stopPropagation(); window.toggleTask('${t.id}', ${!t.completed})" class="w-5 h-5 rounded border flex items-center justify-center ${t.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'text-slate-300'}">
                        ${t.completed ? '<i data-lucide="check" width="12"></i>' : ''}
                    </button>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        function renderRelatedContacts(dealId) {
            const container = document.getElementById('detail-contacts-list');
            const relatedContacts = contacts.filter(c => {
                if (c.dealIds && Array.isArray(c.dealIds)) return c.dealIds.includes(dealId);
                return c.dealId === dealId;
            });
            if (relatedContacts.length === 0) {
                container.innerHTML = '<div class="text-slate-400 text-sm italic py-2">No contacts linked to this deal.</div>';
                return;
            }
            container.innerHTML = relatedContacts.map(c => `
                <div class="bg-white p-3 rounded border border-slate-200 hover:shadow-sm transition cursor-pointer" onclick="window.editContact('${c.id}')">
                    <div class="font-medium text-sm text-slate-800">${c.name}</div>
                    <div class="text-xs text-slate-500 uppercase font-semibold">${c.role || 'No Role'}</div>
                    ${c.company ? `<div class="text-xs text-slate-400 font-medium">${c.company}</div>` : ''}
                    ${c.email ? `<div class="text-xs text-slate-400 mt-1 truncate">${c.email}</div>` : ''}
                </div>
            `).join('');
        }

        // --- Calculator Logic ---
        function calculateDealFinancials(deal) {
            const params = deal.calcParams || {};
            // Robust parsing: strip non-numeric but keep decimal points and negative signs
            const rawValue = deal.value ? deal.value.toString() : '0';
            const cleanValue = rawValue.replace(/[^0-9.-]+/g,"");
            const purchasePrice = parseFloat(cleanValue) || 0;
            
            const rawSale = deal.salePrice ? deal.salePrice.toString() : '0';
            const cleanSale = rawSale.replace(/[^0-9.-]+/g,"");
            const salePrice = parseFloat(cleanSale) || 0;

            const purchaseLtv = params.ltv !== undefined ? parseFloat(params.ltv) : 100;
            const interestRate = params.rate !== undefined ? parseFloat(params.rate) : 6.0;
            const amortization = params.term !== undefined ? parseFloat(params.term) : 300;
            const dscr = params.dscr !== undefined ? parseFloat(params.dscr) : 1.20;
            const capRate = params.cap !== undefined ? parseFloat(params.cap) : 6.0;
            const taxes = params.taxes !== undefined ? parseFloat(params.taxes) : 0;
            const insurance = params.insurance !== undefined ? parseFloat(params.insurance) : 0;
            const landlordWork = params.landlordWork !== undefined ? parseFloat(params.landlordWork) : 0;
            const interestOnly = params.interestOnly || false;
            const useContractRent = params.useContractRent || false;
            const contractRentValue = params.contractRent !== undefined ? parseFloat(params.contractRent) : 0;

            const loanAmount = purchasePrice * (purchaseLtv / 100);
            let annualService = 0;
            if (interestOnly) {
                annualService = loanAmount * (interestRate / 100);
            } else {
                const r = (interestRate / 100) / 12;
                const n = amortization;
                if (r > 0 && n > 0 && loanAmount > 0) {
                    const pmt = (loanAmount * r) / (1 - Math.pow(1 + r, -n));
                    annualService = pmt * 12;
                } else if (n > 0 && loanAmount > 0) annualService = (loanAmount / n) * 12;
            }

            let rentalRate = (annualService * dscr) + taxes + insurance + (landlordWork * 0.10);
            if (deal.stage === 'leased' && contractRentValue > 0) rentalRate = contractRentValue;
            else if (useContractRent) rentalRate = contractRentValue;

            let marketValue = 0;
            if (capRate > 0) marketValue = rentalRate / (capRate / 100);

            const totalCosts = purchasePrice + taxes + insurance + annualService + landlordWork;

            return { purchasePrice, salePrice, rentalRate, marketValue, totalCosts, annualService };
        }

        function renderDealSummary(deal) {
            const summaryContainer = document.getElementById('deal-calc-summary');
            if(!deal.value) {
                summaryContainer.classList.add('hidden');
                return;
            }
            summaryContainer.classList.remove('hidden');

            const fin = calculateDealFinancials(deal);
            const profit = fin.marketValue - fin.totalCosts;
            const roi = fin.totalCosts > 0 ? (profit / fin.totalCosts) * 100 : 0;
            const marketLtv = deal.calcParams?.marketLtv || 70;
            const impliedLtv = fin.marketValue > 0 ? fin.purchasePrice / fin.marketValue : 0;
            const isFinancable = impliedLtv < (marketLtv / 100);

            const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
            const useContract = deal.calcParams?.useContractRent || false;

            document.getElementById('summary-rent-label').textContent = useContract ? "Contract Rent (Override)" : "Required Rent (NOI)";
            document.getElementById('summary-rent').textContent = formatCurrency(fin.rentalRate);
            document.getElementById('summary-value').textContent = formatCurrency(fin.marketValue);
            document.getElementById('summary-profit').textContent = formatCurrency(profit);
            document.getElementById('summary-roi').textContent = Math.round(roi) + '%';
            
            const financeEl = document.getElementById('summary-finance');
            if(isFinancable) {
                financeEl.textContent = "YES";
                financeEl.className = "block font-bold text-emerald-600 text-lg";
            } else {
                financeEl.textContent = "NO";
                financeEl.className = "block font-bold text-red-600 text-lg";
            }
        }

        window.calculateRent = async () => {
            // Guard clause to prevent crash on non-calculator pages
            if(!document.getElementById('res-loan-amount')) return;

            const purchasePrice = getRawValue('calc-price');
            const purchaseLtv = getRawValue('calc-ltv');
            const interestRate = getRawValue('calc-rate');
            const amortization = getRawValue('calc-term');
            const dscr = getRawValue('calc-dscr');
            const capRate = getRawValue('calc-cap');
            const marketLtv = getRawValue('calc-market-ltv');
            const taxes = getRawValue('calc-taxes');
            const insurance = getRawValue('calc-insurance');
            const landlordWork = getRawValue('calc-landlord-work');
            const interestOnly = document.getElementById('calc-interest-only').checked;
            
            const useContractRent = document.getElementById('calc-use-contract').checked;
            const contractRentInput = document.getElementById('calc-contract-rent');
            
            if (useContractRent) {
                contractRentInput.disabled = false;
                contractRentInput.classList.remove('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            } else {
                contractRentInput.disabled = true;
                contractRentInput.classList.add('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            }
            
            const amInput = document.getElementById('calc-term');
            if (interestOnly) {
                amInput.disabled = true;
                amInput.classList.add('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            } else {
                amInput.disabled = false;
                amInput.classList.remove('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            }

            const contractRentValue = getRawValue('calc-contract-rent');

            // Auto-Save
            if (currentlyLoadedDealForCalc) {
                const paramsToSave = {
                    ltv: purchaseLtv, rate: interestRate, term: amortization, dscr: dscr,
                    cap: capRate, marketLtv: marketLtv, useContractRent: useContractRent,
                    contractRent: contractRentValue, interestOnly: interestOnly,
                    taxes: taxes, insurance: insurance, landlordWork: landlordWork
                };
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gc_deals', currentlyLoadedDealForCalc), { calcParams: paramsToSave }).catch(err => console.error("Auto-save failed", err));
            }

            const loanAmount = purchasePrice * (purchaseLtv / 100);
            let annualService = 0, pmt = 0;
            if (interestOnly) {
                annualService = loanAmount * (interestRate / 100);
                pmt = annualService / 12;
            } else {
                const r = (interestRate / 100) / 12;
                const n = amortization;
                if (r > 0 && n > 0 && loanAmount > 0) {
                    const pmt = (loanAmount * r) / (1 - Math.pow(1 + r, -n));
                    annualService = pmt * 12;
                } else if (n > 0 && loanAmount > 0) annualService = (loanAmount / n) * 12;
            }

            const totalHoldingCosts = taxes + insurance + annualService;
            let rentalRate = (annualService * dscr) + taxes + insurance + (landlordWork * 0.10); 
            let isUsingContractRent = false;
            if (useContractRent) {
                rentalRate = contractRentValue;
                isUsingContractRent = true;
            }

            let marketValue = 0;
            if (capRate > 0) marketValue = rentalRate / (capRate / 100);
            let impliedLtv = marketValue > 0 ? purchasePrice / marketValue : 0;
            const totalProjectCost = purchasePrice + totalHoldingCosts + landlordWork;
            const isFinancable = impliedLtv < (marketLtv / 100);
            const profit = marketValue - totalProjectCost;
            const roi = totalProjectCost > 0 ? (profit / totalProjectCost) * 100 : 0;

            const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
            
            document.getElementById('res-loan-amount').textContent = formatCurrency(loanAmount);
            document.getElementById('res-annual-debt').textContent = formatCurrency(annualService);
            document.getElementById('res-monthly-debt').textContent = `${formatCurrency(pmt)} / month`;
            document.getElementById('res-holding-total').textContent = formatCurrency(totalHoldingCosts);
            document.getElementById('res-rental-rate').textContent = formatCurrency(rentalRate);
            
            if (isUsingContractRent) {
                document.getElementById('res-dscr-label').textContent = "Using Contract Rent (Override)";
                document.getElementById('res-dscr-label').className = "text-xs text-blue-600 font-bold mt-0.5";
            } else {
                document.getElementById('res-dscr-label').textContent = `Inc. Debt(DSCR) + Tax/Ins + 10% Work`;
                document.getElementById('res-dscr-label').className = "text-xs text-slate-500 mt-0.5";
            }
            
            document.getElementById('res-market-value').textContent = formatCurrency(marketValue);
            document.getElementById('res-cap-label').textContent = `@ ${capRate}% Cap Rate`;
            document.getElementById('res-implied-ltv').textContent = (impliedLtv * 100).toFixed(2) + '%';
            document.getElementById('res-implied-ltv').className = `text-base font-bold ${isFinancable ? 'text-emerald-600' : 'text-red-600'}`;
            
            const badge = document.getElementById('res-finance-badge');
            if (isFinancable) {
                badge.className = "flex items-center gap-2 px-5 py-2.5 rounded-full font-bold text-lg border bg-emerald-100 text-emerald-700 border-emerald-200";
                badge.innerHTML = `<i data-lucide="check-circle-2" width="20"></i> YES`;
            } else {
                badge.className = "flex items-center gap-2 px-5 py-2.5 rounded-full font-bold text-lg border bg-red-50 text-red-700 border-red-200";
                badge.innerHTML = `<i data-lucide="x-circle" width="20"></i> NO`;
            }

            document.getElementById('res-max-loan').textContent = formatCurrency(marketValue * (marketLtv/100));
            document.getElementById('res-price-check').textContent = formatCurrency(purchasePrice);
            document.getElementById('res-explanation').textContent = isFinancable 
                ? "Since the lender's max loan on the new Market Value exceeds your Purchase Price, you can likely finance the entire purchase."
                : "The lender's max loan on the Market Value is less than the Purchase Price. Down payment required.";

            document.getElementById('res-profit').textContent = formatCurrency(profit);
            document.getElementById('res-roi').textContent = Math.round(roi) + '%';
            if (window.lucide) lucide.createIcons();
        }

        window.loadDealToCalculator = (dealId) => {
            if (!dealId) {
                document.getElementById('calc-price').value = 500000;
                currentlyLoadedDealForCalc = null;
                formatField(document.getElementById('calc-price'), 'currency');
                window.calculateRent();
                return;
            }
            const deal = deals.find(d => d.id === dealId);
            currentlyLoadedDealForCalc = dealId;
            const selectElement = document.getElementById('calc-deal-select');
            if (selectElement) selectElement.value = dealId;

            if (deal) {
                if (deal.value) {
                    const priceEl = document.getElementById('calc-price');
                    priceEl.value = parseFloat(deal.value.toString().replace(/,/g, ''));
                    formatField(priceEl, 'currency');
                }
                const params = deal.calcParams || {};
                const setVal = (id, val, type) => {
                    const el = document.getElementById(id);
                    el.value = val !== undefined ? val : 0;
                    if(type) formatField(el, type);
                };
                setVal('calc-ltv', params.ltv || 100, 'percent');
                setVal('calc-rate', params.rate || 6.0, 'percent');
                document.getElementById('calc-term').value = params.term || 300;
                document.getElementById('calc-dscr').value = params.dscr || 1.20;
                setVal('calc-cap', params.cap || 6.0, 'percent');
                setVal('calc-market-ltv', params.marketLtv || 70, 'percent');
                setVal('calc-taxes', params.taxes || 0, 'currency');
                setVal('calc-insurance', params.insurance || 0, 'currency');
                setVal('calc-landlord-work', params.landlordWork || 0, 'currency');

                document.getElementById('calc-interest-only').checked = params.interestOnly || false;
                document.getElementById('calc-use-contract').checked = params.useContractRent || false;
                
                const contractInput = document.getElementById('calc-contract-rent');
                contractInput.value = params.contractRent || 0;
                formatField(contractInput, 'currency');
                
                window.calculateRent();
            }
        };

        // --- Editing ---
        window.editDeal = (id) => {
            const deal = deals.find(d => d.id === id);
            if (!deal) return;
            document.getElementById('deal-id').value = deal.id;
            const valueEl = document.getElementById('deal-value'); valueEl.value = deal.value || ''; formatField(valueEl, 'currency');
            document.getElementById('deal-name').value = deal.name || '';
            document.getElementById('deal-address').value = deal.address || '';
            document.getElementById('deal-stage').value = deal.stage || 'prospect';
            const salePriceEl = document.getElementById('deal-sale-price'); salePriceEl.value = deal.salePrice || ''; formatField(salePriceEl, 'currency'); 
            document.getElementById('deal-commencement-date').value = deal.commencementDate || '';
            document.getElementById('deal-sale-date').value = deal.saleDate || '';
            document.getElementById('deal-modal-title').textContent = 'Edit Deal';
            document.getElementById('deal-submit-btn').textContent = 'Update Deal';
            document.getElementById('deal-modal').classList.remove('hidden');
        };

        window.editTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            populateDealSelects();
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title || '';
            document.getElementById('task-date').value = task.date || '';
            document.getElementById('task-time').value = task.time || '';
            document.getElementById('task-deal-id').value = task.dealId || '';
            document.getElementById('task-notes').value = task.notes || '';
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-submit-btn').textContent = 'Update Task';
            document.getElementById('task-modal').classList.remove('hidden');
        }

        window.editContact = (id) => {
            const contact = contacts.find(c => c.id === id);
            if (!contact) return;
            populateDealSelects();
            document.getElementById('contact-id').value = contact.id;
            document.getElementById('contact-name').value = contact.name || '';
            document.getElementById('contact-role').value = contact.role || '';
            document.getElementById('contact-company').value = contact.company || '';
            document.getElementById('contact-email').value = contact.email || '';
            document.getElementById('contact-phone').value = contact.phone || '';
            document.getElementById('contact-category').value = contact.category || 'Other';
            const checkboxes = document.querySelectorAll('.contact-deal-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            const linkedDealIds = contact.dealIds || (contact.dealId ? [contact.dealId] : []);
            linkedDealIds.forEach(dealId => {
                const checkbox = document.getElementById(`contact-deal-${dealId}`);
                if (checkbox) checkbox.checked = true;
            });
            document.getElementById('contact-modal-title').textContent = 'Edit Contact';
            document.getElementById('contact-submit-btn').textContent = 'Update Contact';
            document.getElementById('contact-modal').classList.remove('hidden');
        }
        
        window.toggleTask = async (id, status) => await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gc_tasks', id), { completed: status });
        window.deleteTask = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gc_tasks', id));
        window.deleteContact = async (id) => { if(confirm('Delete contact?')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gc_contacts', id)); };
        window.moveStage = async (id, stage) => {
             const ref = getCollectionRef("gc_deals");
             // To update, we need doc reference. In v9, updateDoc takes a doc reference.
             // Our getCollectionRef returns a collection reference.
             // We can construct a doc reference using the same logic.
             // BUT, since we have the ID, we can just use the firestore instance and path string if we knew the path.
             // Let's use a simpler way:
             // We know the deals array has the full object.
             // Wait, updateDoc needs a reference.
             // The cleanest way in this hybrid model is to use the same logic as getCollectionRef but for doc.
             // Let's make a helper:
             const getDocRef = (colName, docId) => {
                 if (typeof __app_id !== 'undefined') return doc(db, 'artifacts', __app_id, 'public', 'data', colName, docId);
                 else return doc(db, colName, docId);
             }
             await updateDoc(getDocRef("gc_deals", id), { stage });
        };
        
        // Start System
        setupAuthListeners();
    </script>
</body>
</html>