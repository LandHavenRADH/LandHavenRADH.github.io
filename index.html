<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Database | Restaurant GroundWorks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-cell {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        .editable-cell:hover {
            background-color: #f1f5f9; /* slate-100 */
            cursor: pointer;
        }
        .table-cell[contenteditable="true"] {
            background-color: #fef9c3; /* yellow-100 */
            outline: 2px solid #f59e0b; /* amber-500 */
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #f1f5f9; /* slate-100 */
        }
        #map {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-800 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 text-center">Admin Access</h2>
            <p class="text-slate-600 mb-6 text-center">Please enter your credentials to access the database.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-slate-700 font-medium mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-slate-700 font-medium mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors">
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Main Content (Initially Hidden) -->
    <div id="main-content" class="hidden">
        <!-- Header -->
        <header id="header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="font-extrabold text-2xl text-slate-900">
                        Restaurant GroundWorks
                    </div>
                    <button id="logout-button" class="bg-amber-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-amber-600 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-12">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-5xl font-extrabold text-slate-900">Property Database</h1>
                <p class="text-lg text-slate-600 mt-4 max-w-3xl mx-auto">A shared database of properties for sale, updated live from our central database.</p>
            </div>

            <!-- Add Property Form -->
            <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 mb-12">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">Add a New Property</h2>
                <form id="add-property-form" class="grid md:grid-cols-4 gap-6">
                    <div class="md:col-span-2">
                        <label for="address" class="block text-slate-700 font-medium mb-2">Address</label>
                        <input type="text" id="address" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 123 Main St" required>
                    </div>
                    <div>
                        <label for="city" class="block text-slate-700 font-medium mb-2">City</label>
                        <input type="text" id="city" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., Indianapolis" required>
                    </div>
                     <div>
                        <label for="dom" class="block text-slate-700 font-medium mb-2">Initial Days on Market</label>
                        <input type="number" id="dom" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 30">
                    </div>
                    <div>
                        <label for="price" class="block text-slate-700 font-medium mb-2">Asking Price ($)</label>
                        <input type="number" id="price" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 750000" required>
                    </div>
                    <div>
                        <label for="sqft" class="block text-slate-700 font-medium mb-2">Square Footage</label>
                        <input type="number" id="sqft" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 2500">
                    </div>
                    <div>
                        <label for="intendedRoi" class="block text-slate-700 font-medium mb-2">Intended ROI (%)</label>
                        <input type="number" step="0.01" id="intendedRoi" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 15.00">
                    </div>
                    <div>
                        <label for="capRate" class="block text-slate-700 font-medium mb-2">Capitalization Rate (%)</label>
                        <input type="number" step="0.01" id="capRate" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., 5.20">
                    </div>
                    <div class="md:col-span-4">
                        <label for="fileLink" class="block text-slate-700 font-medium mb-2">File Link (e.g., Google Drive)</label>
                        <input type="url" id="fileLink" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="https://...">
                    </div>
                    <div class="md:col-span-4">
                        <label for="notes" class="block text-slate-700 font-medium mb-2">Notes</label>
                        <textarea id="notes" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="e.g., High traffic corner, zoned for commercial use..."></textarea>
                    </div>
                    <div class="md:col-span-4 text-right">
                        <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-colors">
                            Add Property
                        </button>
                    </div>
                </form>
            </div>

            <!-- Map Error Message -->
            <div id="map-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Map Error:</strong>
                <span class="block sm:inline">Could not place pins on the map. Please ensure your Google Maps API key is correct, has billing enabled, and that both the "Maps JavaScript API" and "Geocoding API" are enabled in your Google Cloud project.</span>
            </div>

            <!-- Google Map -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 mb-12">
                <div id="map" class="rounded-xl"></div>
            </div>

            <!-- Property Database Table -->
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="table-cell font-semibold sortable-header" data-key="address">Address</th>
                            <th class="table-cell font-semibold sortable-header" data-key="city">City</th>
                            <th class="table-cell font-semibold sortable-header" data-key="price">Asking Price</th>
                            <th class="table-cell font-semibold sortable-header" data-key="sqft">Sq. Footage</th>
                            <th class="table-cell font-semibold sortable-header" data-key="pricePerSqFt">Price per SF</th>
                            <th class="table-cell font-semibold sortable-header" data-key="dom">Current DOM</th>
                            <th class="table-cell font-semibold sortable-header" data-key="intendedRoi">Intended ROI</th>
                            <th class="table-cell font-semibold sortable-header" data-key="capRate">Cap Rate</th>
                            <th class="table-cell font-semibold sortable-header" data-key="minRent">Min. Rental Rate</th>
                            <th class="table-cell font-semibold">Notes</th>
                            <th class="table-cell font-semibold">Map Link</th>
                            <th class="table-cell font-semibold">Attachment</th>
                        </tr>
                    </thead>
                    <tbody id="property-table-body">
                        <!-- Property rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </main>

        <footer class="bg-slate-900 text-slate-400 mt-16">
            <div class="container mx-auto px-6 py-8 text-center">
                <p class="font-bold text-white text-lg mb-2">Restaurant GroundWorks</p>
                <p>&copy; 2025 Restaurant GroundWorks. All Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
          apiKey: "AIza...",
          authDomain: "your-project-id.firebaseapp.com",
          projectId: "your-project-id",
          storageBucket: "your-project-id.appspot.com",
          messagingSenderId: "...",
          appId: "..."
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const propertiesCollection = db.collection("properties");

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const loginOverlay = document.getElementById('login-overlay');
            const mainContent = document.getElementById('main-content');
            const loginForm = document.getElementById('login-form');
            const passwordInput = document.getElementById('password');
            const emailInput = document.getElementById('email');
            const loginError = document.getElementById('login-error');
            const logoutButton = document.getElementById('logout-button');
            const propertyForm = document.getElementById('add-property-form');
            const tableBody = document.getElementById('property-table-body');

            let properties = [];
            let sortState = { key: 'address', direction: 'asc' };
            let map;
            let geocoder;
            let markers = [];

            // --- AUTHENTICATION LOGIC ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    loginOverlay.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    initMap();
                    loadProperties();
                } else {
                    loginOverlay.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        loginError.textContent = error.message;
                    });
            });

            logoutButton.addEventListener('click', () => {
                auth.signOut();
            });

            // --- DATA MANAGEMENT ---
            async function loadProperties() {
                const snapshot = await propertiesCollection.get();
                properties = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortProperties();
                renderTable();
                updateAllMarkers();
            }

            // --- FORMATTING HELPERS ---
            const formatCurrency = (value) => !value || isNaN(value) ? '' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
            const formatCurrencyWithDecimals = (value) => !value || isNaN(value) ? '' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
            const formatNumber = (value) => value ? new Intl.NumberFormat('en-US').format(value) : '';
            const formatPercent = (value) => value ? `${(value * 100).toFixed(2)}%` : '0.00%';

            // --- SORTING ---
            function sortProperties() {
                properties.sort((a, b) => {
                    let valA = a[sortState.key];
                    let valB = b[sortState.key];
                    // ... (sorting logic remains the same)
                    return sortState.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                });
            }

            // --- TABLE RENDERING ---
            function renderTable() {
                tableBody.innerHTML = '';
                if (properties.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="12" class="text-center p-8 text-slate-500">No properties in the database. Add one using the form above.</td></tr>`;
                } else {
                    properties.forEach(prop => {
                        const row = createTableRow(prop);
                        tableBody.appendChild(row);
                    });
                }
                updateSortIndicators();
            }

            function createTableRow(property) {
                const row = document.createElement('tr');
                row.dataset.id = property.id;
                // ... (calculation logic remains the same)
                const pricePerSqFt = (property.price && property.sqft) ? property.price / property.sqft : 0;
                const targetValue = property.price * (1 + (property.intendedRoi || 0));
                const minRent = targetValue * (property.capRate || 0);
                
                let currentDom = property.initialDom || 0;
                if (property.dateAdded) {
                    const dateAdded = new Date(property.dateAdded);
                    if (!isNaN(dateAdded.getTime())) {
                        const today = new Date();
                        dateAdded.setHours(0,0,0,0);
                        today.setHours(0,0,0,0);
                        const differenceInTime = today.getTime() - dateAdded.getTime();
                        const daysPassed = Math.floor(differenceInTime / (1000 * 3600 * 24));
                        currentDom += daysPassed;
                    }
                }

                row.innerHTML = `
                    <td class="table-cell editable-cell" data-key="address">${property.address || ''}</td>
                    <td class="table-cell editable-cell" data-key="city">${property.city || ''}</td>
                    <td class="table-cell editable-cell" data-key="price">${formatCurrency(property.price)}</td>
                    <td class="table-cell editable-cell" data-key="sqft">${formatNumber(property.sqft)}</td>
                    <td class="table-cell">${formatCurrencyWithDecimals(pricePerSqFt)}</td>
                    <td class="table-cell">${currentDom}</td>
                    <td class="table-cell editable-cell" data-key="intendedRoi">${formatPercent(property.intendedRoi)}</td>
                    <td class="table-cell editable-cell" data-key="capRate">${formatPercent(property.capRate)}</td>
                    <td class="table-cell">${formatCurrency(minRent)}</td>
                    <td class="table-cell editable-cell" data-key="notes">${property.notes || ''}</td>
                    <td class="table-cell"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(property.address + ', ' + property.city)}" target="_blank" class="text-indigo-600 hover:underline">View Map</a></td>
                    <td class="table-cell editable-cell" data-key="fileLink">${property.fileLink ? `<a href="${property.fileLink}" target="_blank" class="text-indigo-600 hover:underline">View File</a>` : ''}</td>
                `;
                return row;
            }

            function updateSortIndicators() {
                document.querySelectorAll('.sortable-header').forEach(header => {
                    const key = header.dataset.key;
                    header.innerHTML = header.innerHTML.replace(/ [▲▼]/, '');
                    if (key === sortState.key) {
                        header.innerHTML += sortState.direction === 'asc' ? ' ▲' : ' ▼';
                    }
                });
            }

            // --- EVENT LISTENERS ---
            propertyForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = propertyForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = 'Adding...';

                const newProperty = {
                    address: document.getElementById('address').value.trim(),
                    city: document.getElementById('city').value.trim(),
                    price: parseFloat(document.getElementById('price').value),
                    sqft: parseInt(document.getElementById('sqft').value) || null,
                    initialDom: parseInt(document.getElementById('dom').value) || 0,
                    dateAdded: new Date().toISOString(),
                    notes: document.getElementById('notes').value.trim(),
                    fileLink: document.getElementById('fileLink').value.trim(),
                    intendedRoi: parseFloat(document.getElementById('intendedRoi').value) / 100 || 0,
                    capRate: parseFloat(document.getElementById('capRate').value) / 100 || 0
                };

                try {
                    await propertiesCollection.add(newProperty);
                    propertyForm.reset();
                    loadProperties();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert("Failed to add property.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Add Property';
                }
            });

            tableBody.addEventListener('click', (e) => {
                const cell = e.target.closest('.editable-cell');
                if (!cell || cell.isContentEditable) return;
                cell.setAttribute('contenteditable', 'true');
                cell.focus();
                document.execCommand('selectAll', false, null);
            });

            tableBody.addEventListener('focusout', async (e) => {
                const cell = e.target.closest('.editable-cell');
                if (!cell || !cell.isContentEditable) return;
                cell.setAttribute('contenteditable', 'false');

                const id = cell.closest('tr').dataset.id;
                const key = cell.dataset.key;
                let value = cell.textContent;

                const numericKeys = ['price', 'sqft', 'initialDom'];
                const percentKeys = ['intendedRoi', 'capRate'];

                if (numericKeys.includes(key)) {
                    value = parseFloat(value.replace(/[^0-9.]/g, '')) || 0;
                } else if (percentKeys.includes(key)) {
                    value = (parseFloat(value.replace(/[^0-9.%]/g, '')) || 0) / 100;
                }
                
                try {
                    await propertiesCollection.doc(id).update({ [key]: value });
                    loadProperties();
                } catch (error) {
                    console.error("Error updating document: ", error);
                    alert("Failed to update property. Data will be refreshed.");
                    loadProperties();
                }
            });
            
            // ... (Sort listeners remain the same)

            // --- GOOGLE MAPS INTEGRATION ---
            function initMap() {
                geocoder = new google.maps.Geocoder();
                const indiana = { lat: 39.8647, lng: -86.2604 };
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 7,
                    center: indiana,
                });
            }
            
            function addMarkerToMap(property) {
                const fullAddress = `${property.address}, ${property.city}, IN`;
                geocoder.geocode({ 'address': fullAddress }, (results, status) => {
                    if (status === 'OK') {
                        document.getElementById('map-error').classList.add('hidden');
                        const marker = new google.maps.Marker({
                            map: map,
                            position: results[0].geometry.location,
                            title: property.address,
                        });
                        const infoWindow = new google.maps.InfoWindow({
                            content: `<div><strong>${property.address}</strong><br>${formatCurrency(property.price)}</div>`
                        });
                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                        markers.push({ id: property.id, marker: marker });
                    } else {
                        console.error('Geocode was not successful for the following reason: ' + status);
                        document.getElementById('map-error').classList.remove('hidden');
                    }
                });
            }

            function updateAllMarkers() {
                markers.forEach(({ marker }) => marker.setMap(null));
                markers = [];
                properties.forEach(addMarkerToMap);
            }

            window.initMap = initMap;
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbwa_DBSKhY7E4Akj0nIceTZuWIOPe4nQ&callback=initMap"></script>
</body>
</html>
