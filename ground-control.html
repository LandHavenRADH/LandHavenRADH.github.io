</button>
</nav>
<div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                v2.19.7 • Scope Fixed
                v2.19.8 • Functions Fixed
</div>
</div>

@@ -675,6 +675,116 @@ <h3 class="text-lg font-bold text-slate-800" id="contact-modal-title">Add Contac
return date.toLocaleDateString();
}

        // --- View Switching ---
        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Sidebar
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white', 'shadow-md');
                el.classList.add('text-slate-300', 'hover:bg-slate-800');
            });
            const activeBtn = document.getElementById(`nav-${viewName}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-800');
            activeBtn.classList.add('bg-emerald-600', 'text-white', 'shadow-md');

            // Force calendar render if switching to tasks view
            if (viewName === 'tasks' && calendar) {
                setTimeout(() => calendar.render(), 100);
            }
        };

        // --- Task View Switching (List vs Calendar) ---
        window.switchTaskDisplay = (mode) => {
            const listContainer = document.getElementById('task-list-container');
            const calendarContainer = document.getElementById('task-calendar-container');
            const btnList = document.getElementById('btn-task-list');
            const btnCalendar = document.getElementById('btn-task-calendar');

            if (mode === 'list') {
                listContainer.classList.remove('hidden');
                calendarContainer.classList.add('hidden');
                
                btnList.classList.add('bg-emerald-100', 'text-emerald-700');
                btnList.classList.remove('text-slate-500', 'hover:bg-slate-50');
                
                btnCalendar.classList.add('text-slate-500', 'hover:bg-slate-50');
                btnCalendar.classList.remove('bg-emerald-100', 'text-emerald-700');
            } else {
                listContainer.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                
                btnCalendar.classList.add('bg-emerald-100', 'text-emerald-700');
                btnCalendar.classList.remove('text-slate-500', 'hover:bg-slate-50');
                
                btnList.classList.add('text-slate-500', 'hover:bg-slate-50');
                btnList.classList.remove('bg-emerald-100', 'text-emerald-700');

                // Initialize or Render Calendar
                if (!calendar) {
                    initCalendar();
                } else {
                    calendar.render();
                }
            }
        };

        // --- Modal Logic ---
        window.openModal = (id, dealId = null) => {
            if (id === 'deal-modal') {
                document.getElementById('deal-form').reset();
                document.getElementById('deal-id').value = ''; 
                document.getElementById('deal-modal-title').textContent = 'Add New Deal';
                document.getElementById('deal-submit-btn').textContent = 'Create Deal';
            } else if (id === 'task-modal') {
                document.getElementById('task-form').reset();
                document.getElementById('task-id').value = ''; 
                document.getElementById('task-modal-title').textContent = 'New Task';
                document.getElementById('task-submit-btn').textContent = 'Save Task';
                populateDealSelects();
                if(dealId) document.getElementById('task-deal-id').value = dealId;
            } else if (id === 'contact-modal') {
                document.getElementById('contact-form').reset();
                document.getElementById('contact-id').value = ''; 
                document.getElementById('contact-modal-title').textContent = 'Add Contact';
                document.getElementById('contact-submit-btn').textContent = 'Save Contact';
                populateDealSelects();
                // Check specific deal if passed
                if(dealId) {
                    const checkbox = document.getElementById(`contact-deal-${dealId}`);
                    if (checkbox) checkbox.checked = true;
                }
            }
            document.getElementById(id).classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- Deal Detail Logic ---
        window.openDealDetail = (id) => {
            currentDealId = id;
            const deal = deals.find(d => d.id === id);
            if (!deal) return;

            document.getElementById('detail-deal-name').textContent = deal.name;
            document.getElementById('detail-deal-address').textContent = deal.address;
            document.getElementById('detail-deal-value').textContent = deal.value ? `$${deal.value}` : '$0';
            const stageLabel = STAGES.find(s => s.id === deal.stage)?.label || deal.stage;
            document.getElementById('detail-deal-stage').textContent = stageLabel;

            renderRelatedTasks(id);
            renderRelatedContacts(id);
            renderDealSummary(deal); // New Summary Logic

            document.getElementById('deal-detail-modal').classList.remove('hidden');
        }

        window.editCurrentDeal = () => {
            closeModal('deal-detail-modal');
            editDeal(currentDealId);
        }

// --- RENDER FUNCTIONS (Defined at module level to be accessible) ---

// Render Pipeline
@@ -883,736 +993,167 @@ <h4 class="font-bold text-slate-800">${c.name || 'No Name'}</h4>
renderContacts();
}

        // --- View Switching ---
        window.switchView = (viewName) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Sidebar
            document.querySelectorAll('nav button').forEach(el => {
                el.classList.remove('bg-emerald-600', 'text-white', 'shadow-md');
                el.classList.add('text-slate-300', 'hover:bg-slate-800');
            });
            const activeBtn = document.getElementById(`nav-${viewName}`);
            activeBtn.classList.remove('text-slate-300', 'hover:bg-slate-800');
            activeBtn.classList.add('bg-emerald-600', 'text-white', 'shadow-md');

            // Force calendar render if switching to tasks view
            if (viewName === 'tasks' && calendar) {
                setTimeout(() => calendar.render(), 100);
            }
        };

        // --- Task View Switching (List vs Calendar) ---
        window.switchTaskDisplay = (mode) => {
            const listContainer = document.getElementById('task-list-container');
            const calendarContainer = document.getElementById('task-calendar-container');
            const btnList = document.getElementById('btn-task-list');
            const btnCalendar = document.getElementById('btn-task-calendar');

            if (mode === 'list') {
                listContainer.classList.remove('hidden');
                calendarContainer.classList.add('hidden');
                
                btnList.classList.add('bg-emerald-100', 'text-emerald-700');
                btnList.classList.remove('text-slate-500', 'hover:bg-slate-50');
                
                btnCalendar.classList.add('text-slate-500', 'hover:bg-slate-50');
                btnCalendar.classList.remove('bg-emerald-100', 'text-emerald-700');
            } else {
                listContainer.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                
                btnCalendar.classList.add('bg-emerald-100', 'text-emerald-700');
                btnCalendar.classList.remove('text-slate-500', 'hover:bg-slate-50');
                
                btnList.classList.add('text-slate-500', 'hover:bg-slate-50');
                btnList.classList.remove('bg-emerald-100', 'text-emerald-700');
        // --- Helpers ---
        function populateDealSelects() {
            // Task Select (Still Single)
            const taskOptions = `<option value="">-- General / Unassigned --</option>` + 
                            deals.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            const taskSelect = document.getElementById('task-deal-id');
            if(taskSelect) taskSelect.innerHTML = taskOptions;

                // Initialize or Render Calendar
                if (!calendar) {
                    initCalendar();
            // Contact Select (Multi-Checkbox)
            const contactContainer = document.getElementById('contact-deal-container');
            if(contactContainer) {
                if (deals.length === 0) {
                    contactContainer.innerHTML = '<div class="text-sm text-slate-400 italic">No deals available.</div>';
} else {
                    calendar.render();
                }
            }
        };

        // --- Modal Logic ---
        window.openModal = (id, dealId = null) => {
            if (id === 'deal-modal') {
                document.getElementById('deal-form').reset();
                document.getElementById('deal-id').value = ''; 
                document.getElementById('deal-modal-title').textContent = 'Add New Deal';
                document.getElementById('deal-submit-btn').textContent = 'Create Deal';
            } else if (id === 'task-modal') {
                document.getElementById('task-form').reset();
                document.getElementById('task-id').value = ''; 
                document.getElementById('task-modal-title').textContent = 'New Task';
                document.getElementById('task-submit-btn').textContent = 'Save Task';
                populateDealSelects();
                if(dealId) document.getElementById('task-deal-id').value = dealId;
            } else if (id === 'contact-modal') {
                document.getElementById('contact-form').reset();
                document.getElementById('contact-id').value = ''; 
                document.getElementById('contact-modal-title').textContent = 'Add Contact';
                document.getElementById('contact-submit-btn').textContent = 'Save Contact';
                populateDealSelects();
                // Check specific deal if passed
                if(dealId) {
                    const checkbox = document.getElementById(`contact-deal-${dealId}`);
                    if (checkbox) checkbox.checked = true;
                    contactContainer.innerHTML = deals.map(d => `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="contact-deal-${d.id}" value="${d.id}" class="contact-deal-checkbox rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                            <label for="contact-deal-${d.id}" class="text-sm text-slate-700 cursor-pointer select-none truncate">${d.name}</label>
                        </div>
                    `).join('');
}
}
            document.getElementById(id).classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- Deal Detail Logic ---
        window.openDealDetail = (id) => {
            currentDealId = id;
            const deal = deals.find(d => d.id === id);
            if (!deal) return;

            document.getElementById('detail-deal-name').textContent = deal.name;
            document.getElementById('detail-deal-address').textContent = deal.address;
            document.getElementById('detail-deal-value').textContent = deal.value ? `$${deal.value}` : '$0';
            const STAGES = [
                { id: 'prospect', label: 'Prospecting', color: 'border-blue-500' },
                { id: 'loi', label: 'LOI / Offer', color: 'border-yellow-500' },
                { id: 'dd', label: 'Due Diligence', color: 'border-orange-500' },
                { id: 'closing', label: 'Closing', color: 'border-purple-500' },
                { id: 'leased', label: 'Active Lease', color: 'border-emerald-500' }
            ];
            const stageLabel = STAGES.find(s => s.id === deal.stage)?.label || deal.stage;
            document.getElementById('detail-deal-stage').textContent = stageLabel;

            renderRelatedTasks(id);
            renderRelatedContacts(id);
            renderDealSummary(deal); // New Summary Logic

            document.getElementById('deal-detail-modal').classList.remove('hidden');
        }

        window.editCurrentDeal = () => {
            closeModal('deal-detail-modal');
            editDeal(currentDealId);
        }

        // --- New Function: Render Deal Summary Logic ---
        function renderDealSummary(deal) {
            const summaryContainer = document.getElementById('deal-calc-summary');
            if(!deal.value) {
                summaryContainer.classList.add('hidden');
                return;
            }
            summaryContainer.classList.remove('hidden');

            // Quick Calculation based on dynamic inputs
            const purchasePrice = parseFloat(deal.value.toString().replace(/,/g, '')) || 0;
            if(purchasePrice === 0) {
                summaryContainer.classList.add('hidden');
                return;
            }

            // Defaults (Fallback)
            const defaults = {
                ltv: 100,
                rate: 6.0,
                term: 300,
                dscr: 1.20,
                cap: 6.0,
                marketLtv: 70,
                useContractRent: false,
                contractRent: 0,
                interestOnly: false
            };
            
            // USE DEAL-SPECIFIC PARAMS IF THEY EXIST
            const params = deal.calcParams || defaults;

            const purchaseLtv = parseFloat(params.ltv) || defaults.ltv;
            const interestRate = parseFloat(params.rate) || defaults.rate;
            const amortization = parseFloat(params.term) || defaults.term;
            const dscr = parseFloat(params.dscr) || defaults.dscr;
            const capRate = parseFloat(params.cap) || defaults.cap;
            const marketLtv = parseFloat(params.marketLtv) || defaults.marketLtv;
            const useContractRent = params.useContractRent || defaults.useContractRent;
            const contractRentValue = parseFloat(params.contractRent) || defaults.contractRent;
            const interestOnly = params.interestOnly || defaults.interestOnly;

            const loanAmount = purchasePrice * (purchaseLtv / 100);
            
            let annualService = 0;
            let pmt = 0;

            if (interestOnly) {
                // Simple Interest Only Calculation
                annualService = loanAmount * (interestRate / 100);
                pmt = annualService / 12;
            } else {
                // Standard Amortization Calculation
                const r = (interestRate / 100) / 12;
                const n = amortization;
                
                if (r > 0 && n > 0 && loanAmount > 0) {
                    pmt = (loanAmount * r) / (1 - Math.pow(1 + r, -n));
                } else if (n > 0 && loanAmount > 0) {
                    pmt = loanAmount / n;
            // Calculator Deal Select (New)
            const calcSelect = document.getElementById('calc-deal-select');
            if (calcSelect) {
                // Ensure value is maintained if currently loaded deal is selected
                const currentValue = calcSelect.value;
                const calcOptions = `<option value="">-- Select a Deal --</option>` + 
                                deals.map(d => `<option value="${d.id}" ${d.id === currentValue ? 'selected' : ''}>${d.name}</option>`).join('');
                calcSelect.innerHTML = calcOptions;
                // Re-select if possible (in case innerHTML wiped selection but DOM value persisted, or use state variable)
                if (currentlyLoadedDealForCalc) {
                   calcSelect.value = currentlyLoadedDealForCalc;
}
                annualService = pmt * 12;
            }

            // Determine Rent Source
            let rentalRate = annualService * dscr; 
            let rentLabel = "Required Rent (NOI)";
            let rentAssumptions = `Based on calculator inputs (${purchaseLtv}% LTV, ${interestRate}% Rate${interestOnly ? ', Interest Only' : ''}, ${dscr} DSCR, ${capRate}% Cap)`;

            if (useContractRent) {
                rentalRate = contractRentValue;
                rentLabel = "Contract Rent (Override)";
                rentAssumptions = `Based on Contract Rent override and calculator inputs (${capRate}% Cap, ${marketLtv}% Market LTV)`;
            }

            const marketValue = rentalRate / (capRate / 100);
            const profit = marketValue - purchasePrice;
            const roi = purchasePrice > 0 ? (profit / purchasePrice) * 100 : 0;
            const impliedLtv = purchasePrice / marketValue;
            const isFinancable = impliedLtv < (marketLtv / 100);

            const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);

            document.getElementById('summary-rent-label').textContent = rentLabel;
            document.getElementById('summary-rent').textContent = formatCurrency(rentalRate);
            document.getElementById('summary-value').textContent = formatCurrency(marketValue);
            document.getElementById('summary-profit').textContent = formatCurrency(profit);
            document.getElementById('summary-roi').textContent = Math.round(roi) + '%';
            
            // Update assumptions text
            document.getElementById('summary-assumptions-text').textContent = rentAssumptions;

            const financeEl = document.getElementById('summary-finance');
            if(isFinancable) {
                financeEl.textContent = "YES";
                financeEl.className = "block font-bold text-emerald-600 text-lg";
            } else {
                financeEl.textContent = "NO";
                financeEl.className = "block font-bold text-red-600 text-lg";
}
            if (window.lucide) lucide.createIcons();
}

        // --- Edit Logic ---
        // --- CRUD Operations ---
        window.deleteDeal = async (id) => { if(confirm('Delete deal?')) await deleteDoc(doc(db, "gc_deals", id)); };
        window.moveStage = async (id, stage) => await updateDoc(doc(db, "gc_deals", id), { stage });

        window.editDeal = (id) => {
            const deal = deals.find(d => d.id === id);
            if (!deal) return;

            document.getElementById('deal-id').value = deal.id;
            document.getElementById('deal-name').value = deal.name || '';
            document.getElementById('deal-address').value = deal.address || '';
            document.getElementById('deal-value').value = deal.value || '';
            document.getElementById('deal-stage').value = deal.stage || 'prospect';
            
            document.getElementById('deal-modal-title').textContent = 'Edit Deal';
            document.getElementById('deal-submit-btn').textContent = 'Update Deal';
            
            document.getElementById('deal-modal').classList.remove('hidden');
        };
        window.toggleTask = async (id, status) => await updateDoc(doc(db, "gc_tasks", id), { completed: status });
        window.deleteTask = async (id) => await deleteDoc(doc(db, "gc_tasks", id));

        window.editTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            populateDealSelects();
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title').value = task.title || '';
            document.getElementById('task-date').value = task.date || '';
            document.getElementById('task-time').value = task.time || ''; // Populate time
            document.getElementById('task-deal-id').value = task.dealId || '';
            document.getElementById('task-notes').value = task.notes || '';

            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-submit-btn').textContent = 'Update Task';
            document.getElementById('task-modal').classList.remove('hidden');
        }
        window.deleteContact = async (id) => { if(confirm('Delete contact?')) await deleteDoc(doc(db, "gc_contacts", id)); };

        window.editContact = (id) => {
            const contact = contacts.find(c => c.id === id);
            if (!contact) return;

            populateDealSelects();
            document.getElementById('contact-id').value = contact.id;
            document.getElementById('contact-name').value = contact.name || '';
            document.getElementById('contact-role').value = contact.role || '';
            document.getElementById('contact-company').value = contact.company || ''; // Populate company
            document.getElementById('contact-email').value = contact.email || '';
            document.getElementById('contact-phone').value = contact.phone || '';
            
            // Set Category
            document.getElementById('contact-category').value = contact.category || 'Other';
            
            // Handle Multi-Select Checkboxes
            const checkboxes = document.querySelectorAll('.contact-deal-checkbox');
            checkboxes.forEach(cb => cb.checked = false); // Reset first

            // Prioritize new array format, fallback to legacy string
            const linkedDealIds = contact.dealIds || (contact.dealId ? [contact.dealId] : []);
            
            linkedDealIds.forEach(dealId => {
                const checkbox = document.getElementById(`contact-deal-${dealId}`);
                if (checkbox) checkbox.checked = true;
            });

            document.getElementById('contact-modal-title').textContent = 'Edit Contact';
            document.getElementById('contact-submit-btn').textContent = 'Update Contact';
            document.getElementById('contact-modal').classList.remove('hidden');
        }
        // --- Form Submissions with Error Handling ---
        
        document.getElementById('deal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('deal-submit-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;

        // --- Initialization ---
        function initApp() {
            // Listeners with Error Handling
try {
                // Safely init Lucide
                if (window.lucide) {
                    lucide.createIcons();
                } else {
                    console.warn("Lucide icons not loaded yet.");
                }

                onSnapshot(collection(db, "gc_deals"), (snapshot) => {
                    deals = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    window.renderPipeline();
                    populateDealSelects();
                    // If detailed view is open, refresh it
                    if (currentDealId && !document.getElementById('deal-detail-modal').classList.contains('hidden')) {
                        openDealDetail(currentDealId);
                    }
                }, (error) => {
                    console.error("Deal Sync Error:", error);
                    alert("Error syncing deals: " + error.message + "\nCheck your Firestore permissions.");
                });

                onSnapshot(collection(db, "gc_tasks"), (snapshot) => {
                    tasks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    window.renderTasks();
                    updateCalendarEvents();
                    // If detailed view is open, refresh it
                    if (currentDealId && !document.getElementById('deal-detail-modal').classList.contains('hidden')) {
                        renderRelatedTasks(currentDealId);
                    }
                }, (error) => console.error("Tasks Sync Error:", error));

                onSnapshot(collection(db, "gc_contacts"), (snapshot) => {
                    contacts = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    window.renderContacts();
                    // If detailed view is open, refresh it
                    if (currentDealId && !document.getElementById('deal-detail-modal').classList.contains('hidden')) {
                        renderRelatedContacts(currentDealId);
                    }
                }, (error) => console.error("Contacts Sync Error:", error));
            } catch (e) {
                console.error("Init Error:", e);
            }
        }
                const dealId = document.getElementById('deal-id').value;
                const data = {
                    name: document.getElementById('deal-name').value,
                    address: document.getElementById('deal-address').value,
                    value: document.getElementById('deal-value').value,
                    stage: document.getElementById('deal-stage').value,
                };

        // --- RENT CALCULATOR LOGIC ---
        
        // Populate Calculator Dropdown
        window.loadDealToCalculator = (dealId) => {
            if (!dealId) {
                // Reset inputs if cleared
                document.getElementById('calc-price').value = 500000;
                currentlyLoadedDealForCalc = null;
                calculateRent();
                return;
            }
            const deal = deals.find(d => d.id === dealId);
            currentlyLoadedDealForCalc = dealId;

            // Set dropdown value explicitly so it matches the loaded deal
            const selectElement = document.getElementById('calc-deal-select');
            if (selectElement) selectElement.value = dealId;

            if (deal) {
                // 1. Set Price from Deal Value
                if (deal.value) {
                    const numValue = parseFloat(deal.value.toString().replace(/,/g, ''));
                    if (!isNaN(numValue)) {
                        document.getElementById('calc-price').value = numValue;
                    }
                }
                
                // 2. Load Saved Parameters OR Defaults
                const params = deal.calcParams || {};
                document.getElementById('calc-ltv').value = params.ltv || 100;
                document.getElementById('calc-rate').value = params.rate || 6.0;
                document.getElementById('calc-term').value = params.term || 300;
                document.getElementById('calc-dscr').value = params.dscr || 1.20;
                document.getElementById('calc-cap').value = params.cap || 6.0;
                document.getElementById('calc-market-ltv').value = params.marketLtv || 70;
                
                // Interest Only Checkbox
                const ioCheckbox = document.getElementById('calc-interest-only');
                ioCheckbox.checked = params.interestOnly || false;
                
                // Manually trigger the Interest Only logic for disabling amortization
                const amortizationInput = document.getElementById('calc-term');
                if (ioCheckbox.checked) {
                    amortizationInput.disabled = true;
                    amortizationInput.classList.add('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
                if (dealId) {
                    await updateDoc(doc(db, "gc_deals", dealId), data);
} else {
                    amortizationInput.disabled = false;
                    amortizationInput.classList.remove('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, "gc_deals"), data);
}

                // Contract Rent Checkbox state
                const checkbox = document.getElementById('calc-use-contract');
                checkbox.checked = params.useContractRent || false;
                
                const contractInput = document.getElementById('calc-contract-rent');
                contractInput.value = params.contractRent || 0;
                
                // Manually trigger the enabled/disabled state logic for Contract Rent
                if(checkbox.checked) {
                    contractInput.disabled = false;
                    contractInput.classList.remove('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
                } else {
                    contractInput.disabled = true;
                    contractInput.classList.add('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
                }

                calculateRent(); // Recalculate immediately
            }
        };

        // Core Calculation Function (Updated with Save Logic)
        window.calculateRent = async () => {
            // 1. Get Inputs
            const purchasePrice = parseFloat(document.getElementById('calc-price').value) || 0;
            const purchaseLtv = parseFloat(document.getElementById('calc-ltv').value) || 0;
            const interestRate = parseFloat(document.getElementById('calc-rate').value) || 0;
            const amortization = parseFloat(document.getElementById('calc-term').value) || 0;
            const dscr = parseFloat(document.getElementById('calc-dscr').value) || 0;
            const capRate = parseFloat(document.getElementById('calc-cap').value) || 0;
            const marketLtv = parseFloat(document.getElementById('calc-market-ltv').value) || 0;
            
            const interestOnly = document.getElementById('calc-interest-only').checked;
            const amortizationInput = document.getElementById('calc-term');

            // Interest Only Logic: Disable/Enable Amortization Input
            if (interestOnly) {
                amortizationInput.disabled = true;
                amortizationInput.classList.add('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            } else {
                amortizationInput.disabled = false;
                amortizationInput.classList.remove('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
                e.target.reset();
                closeModal('deal-modal');
            } catch (error) {
                console.error("Error adding/updating deal:", error);
                alert("Failed to save deal. Error: " + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
}
        });

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('task-submit-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;

            // Contract Rent Override Logic
            const useContractRent = document.getElementById('calc-use-contract').checked;
            const contractRentInput = document.getElementById('calc-contract-rent');
            
            // Enable/Disable input based on checkbox state
            if (useContractRent) {
                contractRentInput.disabled = false;
                contractRentInput.classList.remove('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            } else {
                contractRentInput.disabled = true;
                contractRentInput.classList.add('disabled:bg-slate-100', 'disabled:text-slate-400', 'disabled:cursor-not-allowed');
            }

            const contractRentValue = parseFloat(contractRentInput.value) || 0;

            // --- AUTO-SAVE LOGIC ---
            if (currentlyLoadedDealForCalc) {
                // Debounce save (optional but good practice, here direct for simplicity)
                const paramsToSave = {
                    ltv: purchaseLtv,
                    rate: interestRate,
                    term: amortization,
                    dscr: dscr,
                    cap: capRate,
                    marketLtv: marketLtv,
                    useContractRent: useContractRent,
                    contractRent: contractRentValue,
                    interestOnly: interestOnly
            try {
                const taskId = document.getElementById('task-id').value;
                const data = {
                    title: document.getElementById('task-title').value,
                    date: document.getElementById('task-date').value,
                    time: document.getElementById('task-time').value, // Add time
                    dealId: document.getElementById('task-deal-id').value,
                    notes: document.getElementById('task-notes').value,
};
                
                // Only save if values changed (Firestore handles this optimization usually, but good to be safe)
                // We will just fire and forget the update for responsiveness
                updateDoc(doc(db, "gc_deals", currentlyLoadedDealForCalc), { calcParams: paramsToSave }).catch(err => console.error("Auto-save failed", err));
            }


            // 2. Loan Calculations
            const loanAmount = purchasePrice * (purchaseLtv / 100);
            
            let annualService = 0;
            let pmt = 0;

            if (interestOnly) {
                // Simple Interest Only Calculation
                // Annual Interest = Principal * Rate
                annualService = loanAmount * (interestRate / 100);
                pmt = annualService / 12;
            } else {
                // Standard Amortization (PMT Formula)
                const r = (interestRate / 100) / 12;
                const n = amortization;
                
                if (r > 0 && n > 0 && loanAmount > 0) {
                    pmt = (loanAmount * r) / (1 - Math.pow(1 + r, -n));
                } else if (n > 0 && loanAmount > 0) {
                    pmt = loanAmount / n;
                if (taskId) {
                    await updateDoc(doc(db, "gc_tasks", taskId), data);
                } else {
                    data.completed = false;
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, "gc_tasks"), data);
}
                annualService = pmt * 12;
            }
            
            // Determine which Rental Rate to use
            let rentalRate = annualService * dscr; // Default (Required NOI)
            let isUsingContractRent = false;

            if (useContractRent) {
                rentalRate = contractRentValue;
                isUsingContractRent = true;
            }

            // 3. Market Calculations
            let marketValue = 0;
            if (capRate > 0) {
                marketValue = rentalRate / (capRate / 100);
            }

            let impliedLtv = 0;
            if (marketValue > 0) {
                impliedLtv = purchasePrice / marketValue;
            }

            const isFinancable = impliedLtv < (marketLtv / 100);
            const profit = marketValue - purchasePrice;
            const roi = purchasePrice > 0 ? (profit / purchasePrice) * 100 : 0;

            // 4. Update UI
            const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
            
            document.getElementById('res-loan-amount').textContent = formatCurrency(loanAmount);
            document.getElementById('res-annual-debt').textContent = formatCurrency(annualService);
            document.getElementById('res-monthly-debt').textContent = `${formatCurrency(pmt)} / month`;
            
            document.getElementById('res-rental-rate').textContent = formatCurrency(rentalRate);
            
            // Update Label based on source
            if (isUsingContractRent) {
                document.getElementById('res-dscr-label').textContent = "Using Contract Rent (Override)";
                document.getElementById('res-dscr-label').className = "text-xs text-blue-600 font-bold mt-0.5";
            } else {
                document.getElementById('res-dscr-label').textContent = `Based on ${dscr}x DSCR`;
                document.getElementById('res-dscr-label').className = "text-xs text-slate-500 mt-0.5";
            }
            
            document.getElementById('res-market-value').textContent = formatCurrency(marketValue);
            document.getElementById('res-cap-label').textContent = `@ ${capRate}% Cap Rate`;
            
            document.getElementById('res-implied-ltv').textContent = (impliedLtv * 100).toFixed(2) + '%';
            document.getElementById('res-implied-ltv').className = `text-base font-bold ${isFinancable ? 'text-emerald-600' : 'text-red-600'}`;
            document.getElementById('res-ltv-subtext').textContent = `Target: < ${marketLtv}%`;

            // Finance Badge
            const badge = document.getElementById('res-finance-badge');
            if (isFinancable) {
                badge.className = "flex items-center gap-2 px-5 py-2.5 rounded-full font-bold text-lg border bg-emerald-100 text-emerald-700 border-emerald-200";
                badge.innerHTML = `<i data-lucide="check-circle-2" width="20"></i> YES`;
            } else {
                badge.className = "flex items-center gap-2 px-5 py-2.5 rounded-full font-bold text-lg border bg-red-50 text-red-700 border-red-200";
                badge.innerHTML = `<i data-lucide="x-circle" width="20"></i> NO`;
                
                e.target.reset();
                closeModal('task-modal');
            } catch (error) {
                console.error("Error saving task:", error);
                alert("Failed to save task: " + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
}
            if (window.lucide) lucide.createIcons();

            // Explanation
            document.getElementById('res-max-loan').textContent = formatCurrency(marketValue * (marketLtv/100));
            document.getElementById('res-price-check').textContent = formatCurrency(purchasePrice);
            document.getElementById('res-explanation').textContent = isFinancable 
                ? "Since the lender's max loan on the new Market Value exceeds your Purchase Price, you can likely finance the entire purchase."
                : "The lender's max loan on the Market Value is less than the Purchase Price. Down payment required.";

            // ROI
            document.getElementById('res-profit').textContent = formatCurrency(profit);
            document.getElementById('res-roi').textContent = Math.round(roi) + '%';
        };

        // Attach listeners to all calculator inputs
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('.calc-input');
            inputs.forEach(input => {
                // For checkbox and number inputs
                input.addEventListener('input', calculateRent);
                input.addEventListener('change', calculateRent); // Catch checkbox changes specifically
            });
            // Initial calc
            calculateRent();
        });
        
        // --- FDD PROCESSOR ---
        document.getElementById('fdd-file-input').addEventListener('change', (e) => {
             const file = e.target.files[0];
             if(file) {
                 document.getElementById('fdd-file-name').textContent = file.name;
                 document.getElementById('fdd-file-name').classList.remove('hidden');
                 document.getElementById('fdd-controls').classList.remove('hidden');
             }
});

        document.getElementById('fdd-process-btn').addEventListener('click', async () => {
            const file = document.getElementById('fdd-file-input').files[0];
            if (!file) return;

            const statusEl = document.getElementById('fdd-status');
            const processBtn = document.getElementById('fdd-process-btn');
            
            statusEl.classList.remove('hidden');
            processBtn.disabled = true;
            processBtn.classList.add('opacity-50', 'cursor-not-allowed');
        document.getElementById('contact-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('contact-submit-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;

try {
                // 1. Upload to Firebase Storage
                statusEl.textContent = "Uploading PDF...";
                const storageRef = ref(storage, `fdd_docs/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                const fileUrl = await getDownloadURL(storageRef);

                // 2. Extract Text (Client-side PDF.js)
                statusEl.textContent = "Extracting text from PDF (this may take a while)...";
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                const contactId = document.getElementById('contact-id').value;

                let fullText = "";
                // Limit to first 100 pages to avoid crashing/timeouts for huge docs in this demo
                // Ideally, we'd search for "Item 20" or "Signed but not open" in page headers first
                const maxPages = Math.min(pdf.numPages, 150); 
                
                for (let i = 1; i <= maxPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + "\n";
                }

                // 3. Send to Gemini for Parsing
                statusEl.textContent = "Analyzing with AI to find contacts...";
                // We use a helper function to call Gemini (assuming GEMINI_API_KEY is available)
                const jsonStr = await callGeminiForFDD(fullText); 
                
                let contacts = [];
                try {
                    // Clean up potential markdown code blocks
                    const cleanedJson = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                    contacts = JSON.parse(cleanedJson);
                } catch (e) {
                    console.error("JSON Parse Error:", e);
                    throw new Error("Failed to parse AI response.");
                }
                // Harvest Checked Deal IDs
                const selectedDealIds = Array.from(document.querySelectorAll('.contact-deal-checkbox:checked')).map(cb => cb.value);

                const data = {
                    name: document.getElementById('contact-name').value,
                    role: document.getElementById('contact-role').value,
                    email: document.getElementById('contact-email').value,
                    phone: document.getElementById('contact-phone').value,
                    company: document.getElementById('contact-company').value, // Save Company
                    category: document.getElementById('contact-category').value, // Save Category
                    dealIds: selectedDealIds, 
                    dealId: null 
                };

                if (contacts.length === 0) {
                    alert("No contacts found in the scanned pages. The list might be in an Exhibit at the end of the document which wasn't fully processed, or the format was unrecognizable.");
                    return;
                if (contactId) {
                    await updateDoc(doc(db, "gc_contacts", contactId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, "gc_contacts"), data);
}

                // 4. Generate Excel
                statusEl.textContent = `Found ${contacts.length} contacts. Generating Excel...`;
                const ws = XLSX.utils.json_to_sheet(contacts);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Signed Not Open");
                XLSX.writeFile(wb, `${file.name.replace('.pdf', '')}_contacts.xlsx`);

                statusEl.textContent = "Done! Download started.";

                e.target.reset();
                closeModal('contact-modal');
} catch (error) {
                console.error("FDD Process Error:", error);
                statusEl.textContent = "Error: " + error.message;
                alert("An error occurred during processing. See console for details.");
                console.error("Error saving contact:", error);
                alert("Failed to save contact: " + error.message);
} finally {
                processBtn.disabled = false;
                processBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.innerText = originalText;
                btn.disabled = false;
}
});

        async function callGeminiForFDD(text) {
             const model = 'gemini-1.5-flash-latest';
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
             
             // Construct a smart prompt to find the specific table
             // FDDs usually have this in "Item 20" or "Exhibit" lists
             const prompt = `
                I am providing the text content of a Franchise Disclosure Document (FDD). 
                Your task is to identify the list of franchisees who have **Signed a Franchise Agreement but have not yet opened an outlet**. 
                This is typically found in **Item 20** (Tables) or an **Exhibit** at the end of the document.

                Please extract the data into a JSON Array with objects having these keys:
                "Name", "Address", "City", "State", "Zip", "Phone".

                If a field is missing, use an empty string.
                Return ONLY the JSON array.

                Document Text:
                ${text.substring(0, 100000)} 
             `; // Sending first 100k chars for safety, though Flash can handle more.

             const payload = {
                 contents: [{ parts: [{ text: prompt }] }]
             };

             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(payload)
             });

             if (!response.ok) throw new Error("Gemini API Error");
             const result = await response.json();
             return result.candidates[0].content.parts[0].text;
        }

        // --- Helper: Populate Deal Selects ---
        function populateDealSelects() {
            // Task Select (Still Single)
            const taskOptions = `<option value="">-- General / Unassigned --</option>` + 
                            deals.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            const taskSelect = document.getElementById('task-deal-id');
            if(taskSelect) taskSelect.innerHTML = taskOptions;

            // Contact Select (Multi-Checkbox)
            const contactContainer = document.getElementById('contact-deal-container');
            if(contactContainer) {
                if (deals.length === 0) {
                    contactContainer.innerHTML = '<div class="text-sm text-slate-400 italic">No deals available.</div>';
                } else {
                    contactContainer.innerHTML = deals.map(d => `
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="contact-deal-${d.id}" value="${d.id}" class="contact-deal-checkbox rounded border-slate-300 text-emerald-600 focus:ring-emerald-500">
                            <label for="contact-deal-${d.id}" class="text-sm text-slate-700 cursor-pointer select-none truncate">${d.name}</label>
                        </div>
                    `).join('');
                }
            }

            // Calculator Deal Select (New)
            const calcSelect = document.getElementById('calc-deal-select');
            if (calcSelect) {
                // Ensure value is maintained if currently loaded deal is selected
                const currentValue = calcSelect.value;
                const calcOptions = `<option value="">-- Select a Deal --</option>` + 
                                deals.map(d => `<option value="${d.id}" ${d.id === currentValue ? 'selected' : ''}>${d.name}</option>`).join('');
                calcSelect.innerHTML = calcOptions;
                // Re-select if possible (in case innerHTML wiped selection but DOM value persisted, or use state variable)
                if (currentlyLoadedDealForCalc) {
                   calcSelect.value = currentlyLoadedDealForCalc;
                }
            }
        }

</script>
</body>
</html>